<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>2&nbsp; Estimating survivor functions: life-tables and Kaplan-Meier – Survival analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./parametric.html" rel="next">
<link href="./background.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-485d01fc63b59abcd3ee1bf1e8e2748d.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./survivor.html"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Estimating survivor functions: life-tables and Kaplan-Meier</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Survival analysis</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Acknowledgements</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./background.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Background and Basic Concepts</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./survivor.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Estimating survivor functions: life-tables and Kaplan-Meier</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./parametric.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Parametric one-sample models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./twosample.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Two Sample Comparisons</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./aft.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Accelerated Failure Time (AFT) Models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./proportionalhazards.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Proportional Hazards Models</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#preliminaries" id="toc-preliminaries" class="nav-link active" data-scroll-target="#preliminaries"><span class="header-section-number">2.1</span> Preliminaries</a>
  <ul class="collapse">
  <li><a href="#sec-factorisation" id="toc-sec-factorisation" class="nav-link" data-scroll-target="#sec-factorisation"><span class="header-section-number">2.1.1</span> The factorisation method</a></li>
  <li><a href="#terminology-at-risk" id="toc-terminology-at-risk" class="nav-link" data-scroll-target="#terminology-at-risk"><span class="header-section-number">2.1.2</span> Terminology: “at risk”</a></li>
  </ul></li>
  <li><a href="#life-table-estimate-of-the-survivor-function" id="toc-life-table-estimate-of-the-survivor-function" class="nav-link" data-scroll-target="#life-table-estimate-of-the-survivor-function"><span class="header-section-number">2.2</span> Life table estimate of the survivor function</a></li>
  <li><a href="#kaplan-meier-estimate-of-st" id="toc-kaplan-meier-estimate-of-st" class="nav-link" data-scroll-target="#kaplan-meier-estimate-of-st"><span class="header-section-number">2.3</span> Kaplan-Meier estimate of <span class="math inline">\(S(t)\)</span></a>
  <ul class="collapse">
  <li><a href="#general-notation-and-formula" id="toc-general-notation-and-formula" class="nav-link" data-scroll-target="#general-notation-and-formula"><span class="header-section-number">2.3.1</span> General notation and formula</a></li>
  <li><a href="#finding-the-median-survival-time-from-km-plots" id="toc-finding-the-median-survival-time-from-km-plots" class="nav-link" data-scroll-target="#finding-the-median-survival-time-from-km-plots"><span class="header-section-number">2.3.2</span> Finding the Median Survival Time from KM plots</a></li>
  <li><a href="#variance-of-the-kaplan-meier-estimator" id="toc-variance-of-the-kaplan-meier-estimator" class="nav-link" data-scroll-target="#variance-of-the-kaplan-meier-estimator"><span class="header-section-number">2.3.3</span> Variance of the Kaplan-Meier estimator</a></li>
  <li><a href="#RKMEst" id="toc-RKMEst" class="nav-link" data-scroll-target="#RKMEst"><span class="header-section-number">2.3.4</span> Calculating Kaplan-Meier Estimates in R</a></li>
  </ul></li>
  <li><a href="#tasks" id="toc-tasks" class="nav-link" data-scroll-target="#tasks"><span class="header-section-number">2.4</span> Tasks</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Estimating survivor functions: life-tables and Kaplan-Meier</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="callout callout-style-default callout-caution no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Aims for this chapter
</div>
</div>
<div class="callout-body-container callout-body">
<p>In this chapter, the aim is to estimate the survivor function <span class="math inline">\(S(t)\)</span> for <span class="math inline">\(t\ge 0\)</span>, given a sample of survival times. The sample may include censored observations, and so we need to be able to incorporate censored observations in survivor function estimates. In particular, we will:</p>
<ol type="1">
<li><p>learn how to use the life-table method and Kaplan-Meier method for estimating <span class="math inline">\(S(t)\)</span>;</p></li>
<li><p>understand the data requirements of each method: how the life-table method works with grouped data, and the Kaplan-Meier method works with individual survival/censoring times;</p></li>
<li><p>understand the key role of conditional probability for estimating <span class="math inline">\(S(t)\)</span>: how we make use of results such as <span class="math inline">\(P(T\ge t_2) = P(T\ge t_1)P(T\ge t_2 | T\ge t_1)\)</span> for <span class="math inline">\(t_2&gt;t_1\)</span>;</p></li>
<li><p>learn how to implement the Kaplan-Meier method using R.</p></li>
</ol>
</div>
</div>
<section id="preliminaries" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="preliminaries"><span class="header-section-number">2.1</span> Preliminaries</h2>
<p>You may have seen before how to estimate a cumulative distribution function <span class="math inline">\(F(t)\)</span> using the empirical distribution function. We can obviously use the same idea to estimate a survivor function <span class="math inline">\(S(t)=1-F(t)\)</span>. The method is</p>
<ul>
<li><p>obtain a sample of values <span class="math inline">\(t_1,\ldots,t_n\)</span> from the distribution of <span class="math inline">\(T\)</span></p></li>
<li><p>estimate the survivor function <span class="math inline">\(S(t) = P(T\ge t)\)</span> for any value of <span class="math inline">\(t\)</span> by counting the proportion of values in the sample <span class="math inline">\(t_1,\ldots,t_n\)</span> that are greater than or equal to <span class="math inline">\(t\)</span>.</p></li>
</ul>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Example
</div>
</div>
<div class="callout-body-container callout-body">
<p>We will test the method above in R to estimate <span class="math inline">\(S(1)=P(T\ge 1)\)</span> where <span class="math inline">\(T\sim exp(rate = 1)\)</span>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fix the random seed so you can reproduce this</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>) </span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># generate a sample of 1000 random observations from the exp(rate = 1) distribution</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>t_sample <span class="ot">&lt;-</span> <span class="fu">rexp</span>(<span class="at">n =</span> <span class="dv">1000</span>, <span class="at">rate =</span> <span class="dv">1</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># count how many observations in the sample are greater than or equal to 1</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># and divide by 1000 to get the proportion</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(t_sample <span class="sc">&gt;=</span> <span class="dv">1</span>) <span class="sc">/</span> <span class="dv">1000</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.393</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># compare with the true value of the survivor function:</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="sc">-</span> <span class="fu">pexp</span>(<span class="dv">1</span>, <span class="at">rate =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.3678794</code></pre>
</div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>This approach, on its own, won’t work if the sample of observations includes censored data!</p>
</div>
</div>
<section id="sec-factorisation" class="level3" data-number="2.1.1">
<h3 data-number="2.1.1" class="anchored" data-anchor-id="sec-factorisation"><span class="header-section-number">2.1.1</span> The factorisation method</h3>
<p>We will see later that it can be convenient to estimate a survival probability via a factorisation. As an example, if we want to estimate <span class="math inline">\(S(2)\)</span>, we can write</p>
<p><span class="math display">\[
S(2)=P(T\ge2) = P(T\ge1) P(T\ge 2|T\ge 1) = S(1)P(T\ge 2|T\ge 1)
\]</span></p>
<ol type="1">
<li>Suppose we have a sample of survival times <span class="math inline">\(t_1,\ldots t_n\)</span> from the distribution of <span class="math inline">\(T\)</span></li>
<li>We estimate <span class="math inline">\(S(1)\)</span> exactly as before</li>
<li>We estimate <span class="math inline">\(P(T\ge 2|T\ge 1)\)</span> by counting the proportion of observations in our sample greater than or equal to 2, <em>out of those observations which are greater than or equal to 1</em>.</li>
<li>We multiply the estimates from steps 2 and 3 to get an estimate of <span class="math inline">\(S(2)\)</span></li>
</ol>
<p>This may seem unnecessarily complicated, but it will be useful for handling censored observations in our sample.</p>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Example
</div>
</div>
<div class="callout-body-container callout-body">
<p>We illustrate the above approach in R, again with <span class="math inline">\(T\sim exp(rate = 1)\)</span> for illustration.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fix the random seed so you can reproduce this</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>) </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># generate a sample of 1000 random observations from the exp(rate=1) distribution</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>t_sample <span class="ot">&lt;-</span> <span class="fu">rexp</span>(<span class="dv">1000</span>) </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co"># count how many observations in the sample are greater than or equal to 1</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co"># and divide by 100 to get the proportion</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">sum</span>(t_sample <span class="sc">&gt;=</span> <span class="dv">1</span>) <span class="sc">/</span> <span class="dv">1000</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract observations in the sample are greater than or equal to 1</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>t_sample_above_1 <span class="ot">&lt;-</span> t_sample[t_sample <span class="sc">&gt;=</span><span class="dv">1</span>]</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="co"># count how many observations in the reduced are greater than or equal to 2</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="co"># and divide by the sample size to get the proportion</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">sum</span>(t_sample_above_1 <span class="sc">&gt;=</span> <span class="dv">2</span>) <span class="sc">/</span> <span class="fu">length</span>(t_sample_above_1)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Multiply to estimate the desired probability</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>p1 <span class="sc">*</span> p2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.137</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare with the true value of the probability</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="sc">-</span> <span class="fu">pexp</span>(<span class="dv">2</span>, <span class="at">rate =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.1353353</code></pre>
</div>
</div>
</div>
</div>
</section>
<section id="terminology-at-risk" class="level3" data-number="2.1.2">
<h3 data-number="2.1.2" class="anchored" data-anchor-id="terminology-at-risk"><span class="header-section-number">2.1.2</span> Terminology: “at risk”</h3>
<p>We use the term “at risk” to mean that the individual has not yet had the failure event (e.g.&nbsp;death): they are still “at risk” of the event occurring. The number of patients at risk during at some interval is the maximum number of events that could occur in that interval</p>
<p>Continuing the R example above, we started with a sample of 1000 patients, so there were 1000 patients at risk for <span class="math inline">\(t\ge 0\)</span>. At time <span class="math inline">\(t=1\)</span>, if we count how many patients have had their event by this time:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(t_sample<span class="sc">&lt;</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 607</code></pre>
</div>
</div>
<p>we say that there are <span class="math inline">\(1000-607\)</span> patients at risk at time <span class="math inline">\(t\ge 1\)</span>. We estimate <span class="math display">\[
P(T\ge 2 | T\ge 1)
\]</span> by computing <span class="math display">\[
\frac{\mbox{number of patients with survival times }\ge 2}{\mbox{number of patients at risk during the period time }t\ge1}
\]</span></p>
</section>
</section>
<section id="life-table-estimate-of-the-survivor-function" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="life-table-estimate-of-the-survivor-function"><span class="header-section-number">2.2</span> Life table estimate of the survivor function</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The life table method (also known as the “actuarial method”) involves grouping the data: this loses information, and the estimate will depend on the choice of grouping. The life-table method can, however, handled censored observations. Note that the data may have been collated in a grouped format to start with, so that exact survival times/censoring times are not available. Note also that this method is not actually estimating the entire <em>function</em> <span class="math inline">\(S(t)\)</span> for all <span class="math inline">\(t\ge 0\)</span>; it estimates <span class="math inline">\(S(t)\)</span> at a finite set of <span class="math inline">\(t\)</span> values.</p>
</div>
</div>
<p>We will use the <code>lung</code> dataset as an example.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>lungData <span class="ot">&lt;-</span> survival<span class="sc">::</span>lung <span class="sc">%&gt;%</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(time, status) <span class="sc">%&gt;%</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span> (<span class="at">status =</span> status <span class="sc">-</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol type="1">
<li>Choose a set of time intervals. The end point for the last interval needs to exceed the longest survival/censoring time in the data. We have</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">max</span>(lungData<span class="sc">$</span>time)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1022</code></pre>
</div>
</div>
<p>and we choose the intervals to be <span class="math inline">\([0, 200), [200, 400), [400, 600), [600, 800), [800, 1000), [1000, 1200)\)</span>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>breaks <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1200</span>, <span class="at">by =</span> <span class="dv">200</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This means we will obtain estimates of <span class="math inline">\(S(200), S(400), S(600), S(800), S(1000)\)</span>. If we want to estimate <span class="math inline">\(S(t)\)</span> at more values of <span class="math inline">\(t\)</span>, we would have to choose more intervals. (If the data were grouped to begin with, we would just use the intervals provided with the data.)</p>
<ol start="2" type="1">
<li>Count the number of deaths and the number of censored observations in each interval. Count also the number of patients at risk at the start of each interval: the total sample size, minus all deaths and censored observations that have occurred prior to the start of the interval.</li>
</ol>
<p>This code assigns each observation to an interval</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>lung_binned <span class="ot">&lt;-</span> lungData <span class="sc">%&gt;%</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use cut to assign each 'time' to a 200-day interval</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">time_interval =</span> <span class="fu">cut</span>(time,</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>                        <span class="at">breaks =</span> breaks,</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>                        <span class="at">right =</span> <span class="cn">FALSE</span>, <span class="co"># Intervals are [start, end)</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>                        <span class="at">include.lowest =</span> <span class="cn">TRUE</span>, <span class="co"># Include the starting point (0)</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>                        <span class="at">labels =</span> <span class="fu">paste0</span>(breaks[<span class="sc">-</span><span class="fu">length</span>(breaks)], <span class="st">"-"</span>, breaks[<span class="sc">-</span><span class="dv">1</span>]) <span class="co"># Custom labels</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(lung_binned)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  time status time_interval
1  306      1       200-400
2  455      1       400-600
3 1010      0     1000-1200
4  210      1       200-400
5  883      1      800-1000
6 1022      0     1000-1200</code></pre>
</div>
</div>
<p>and this code does the counting:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>survival_summary_table <span class="ot">&lt;-</span> lung_binned <span class="sc">%&gt;%</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(time_interval) <span class="sc">%&gt;%</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">N_Deaths =</span> <span class="fu">sum</span>(status <span class="sc">==</span> <span class="dv">1</span>), <span class="co"># Count observations where status is 1 (Dead)</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">N_Censored =</span> <span class="fu">sum</span>(status <span class="sc">==</span> <span class="dv">0</span>), <span class="co"># Count observations where status is 0 (Censored)</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">at_risk =</span> <span class="fu">nrow</span>(lungData) <span class="sc">-</span> <span class="fu">c</span>(<span class="dv">0</span>,</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>                                      <span class="fu">cumsum</span>(N_Deaths)[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>] <span class="sc">+</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>                                      <span class="fu">cumsum</span>(N_Censored)[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]))  </span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(survival_summary_table)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">time_interval</th>
<th style="text-align: right;">N_Deaths</th>
<th style="text-align: right;">N_Censored</th>
<th style="text-align: right;">at_risk</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">0-200</td>
<td style="text-align: right;">72</td>
<td style="text-align: right;">12</td>
<td style="text-align: right;">228</td>
</tr>
<tr class="even">
<td style="text-align: left;">200-400</td>
<td style="text-align: right;">54</td>
<td style="text-align: right;">33</td>
<td style="text-align: right;">144</td>
</tr>
<tr class="odd">
<td style="text-align: left;">400-600</td>
<td style="text-align: right;">22</td>
<td style="text-align: right;">11</td>
<td style="text-align: right;">57</td>
</tr>
<tr class="even">
<td style="text-align: left;">600-800</td>
<td style="text-align: right;">15</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">24</td>
</tr>
<tr class="odd">
<td style="text-align: left;">800-1000</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">8</td>
</tr>
<tr class="even">
<td style="text-align: left;">1000-1200</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">2</td>
</tr>
</tbody>
</table>
</div>
</div>
<ol start="3" type="1">
<li>Now we deal with the censoring. Considering <span class="math inline">\(S(200)\)</span>, for example, we <em>could</em> estimate this by <span class="math display">\[
\frac{228 - 72}{228}
\]</span> as there were 228 patients at risk for the period <span class="math inline">\(0\le t &lt; 200\)</span>, and there were 72 deaths during this period. But 12 patients were not observed for the full 200 days, as they were censored.</li>
</ol>
<div class="callout callout-style-default callout-caution no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
The actuarial assumption
</div>
</div>
<div class="callout-body-container callout-body">
<p>We make the “actuarial assumption” that censoring within an interval occurs at a uniform rate over that interval. So if there were 12 censored observations occurring at a uniform rate over the interval <span class="math inline">\([0, 200)\)</span>, we treat this as equivalent to <span class="math inline">\(0.5 \times 12\)</span> patients being at risk for the whole interval. The “adjusted” number at risk is calculated as <span class="math inline">\(228 - 0.5\times 12\)</span></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>survival_summary_table <span class="ot">&lt;-</span> survival_summary_table <span class="sc">%&gt;%</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">at_risk_adjusted =</span> at_risk <span class="sc">-</span> <span class="fl">0.5</span> <span class="sc">*</span> N_Censored)  </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(survival_summary_table)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">time_interval</th>
<th style="text-align: right;">N_Deaths</th>
<th style="text-align: right;">N_Censored</th>
<th style="text-align: right;">at_risk</th>
<th style="text-align: right;">at_risk_adjusted</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">0-200</td>
<td style="text-align: right;">72</td>
<td style="text-align: right;">12</td>
<td style="text-align: right;">228</td>
<td style="text-align: right;">222.0</td>
</tr>
<tr class="even">
<td style="text-align: left;">200-400</td>
<td style="text-align: right;">54</td>
<td style="text-align: right;">33</td>
<td style="text-align: right;">144</td>
<td style="text-align: right;">127.5</td>
</tr>
<tr class="odd">
<td style="text-align: left;">400-600</td>
<td style="text-align: right;">22</td>
<td style="text-align: right;">11</td>
<td style="text-align: right;">57</td>
<td style="text-align: right;">51.5</td>
</tr>
<tr class="even">
<td style="text-align: left;">600-800</td>
<td style="text-align: right;">15</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">24</td>
<td style="text-align: right;">23.5</td>
</tr>
<tr class="odd">
<td style="text-align: left;">800-1000</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">6.0</td>
</tr>
<tr class="even">
<td style="text-align: left;">1000-1200</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">1.0</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>We can now calculate estimates of the survivor function through repeated use of the factorisation method in <a href="#sec-factorisation" class="quarto-xref"><span>Section 2.1.1</span></a></p>
<table class="caption-top table">
<colgroup>
<col style="width: 21%">
<col style="width: 21%">
<col style="width: 35%">
<col style="width: 21%">
</colgroup>
<thead>
<tr class="header">
<th><span class="math inline">\(j\)</span></th>
<th><span class="math inline">\(t_j\)</span></th>
<th><span class="math inline">\(\hat{P}(T\ge t_j | T \ge t_{j-1})\)</span></th>
<th><span class="math inline">\(\hat{S}(t_j) =\hat{S}(t_{j-1})\times \hat{P}(T\ge t_j | T \ge t_{j-1})\)</span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>0</td>
<td>-</td>
<td>1</td>
</tr>
<tr class="even">
<td>2</td>
<td>200</td>
<td><span class="math inline">\(\frac{222-72}{72}\)</span></td>
<td><span class="math inline">\(\frac{222-72}{222}\)</span></td>
</tr>
<tr class="odd">
<td>3</td>
<td>400</td>
<td><span class="math inline">\(\frac{127.5-54}{127.5}\)</span></td>
<td><span class="math inline">\(\frac{222-72}{222}\times \frac{127.5-54}{127.5}\)</span></td>
</tr>
<tr class="even">
<td>4</td>
<td>600</td>
<td><span class="math inline">\(\frac{51.5-22}{51.5}\)</span></td>
<td><span class="math inline">\(\frac{222-72}{222}\times \frac{127.5-54}{127.5}\times \frac{51.5-22}{51.5}\)</span></td>
</tr>
<tr class="odd">
<td>5</td>
<td>800</td>
<td><span class="math inline">\(\frac{23.5-15}{23.5}\)</span></td>
<td><span class="math inline">\(\frac{222-72}{222}\times \frac{127.5-54}{127.5}\times \frac{51.5-22}{51.5}\times \frac{23.5-15}{23.5}\)</span></td>
</tr>
<tr class="even">
<td>6</td>
<td>1000</td>
<td><span class="math inline">\(\frac{6-2}{6}\)</span></td>
<td><span class="math inline">\(\frac{222-72}{222} \times \ldots \times \frac{6-2}{6}\)</span></td>
</tr>
<tr class="odd">
<td>7</td>
<td>1200</td>
<td><span class="math inline">\(\frac{1-0}{1}\)</span></td>
<td><span class="math inline">\(\frac{222-72}{222} \times \ldots \times \frac{1-0}{1}\)</span></td>
</tr>
</tbody>
</table>
<p>Note that the estimates would be less reliable as time increases, as the number at risk decreases; we don’t expect the statement <span class="math inline">\(P(T\ge 1200 | T\ge 1000)=1\)</span> to be true, for example.</p>
<p>To do the calculations in R:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>P <span class="ot">&lt;-</span> (survival_summary_table<span class="sc">$</span>at_risk_adjusted <span class="sc">-</span> survival_summary_table<span class="sc">$</span>N_Deaths)<span class="sc">/</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  survival_summary_table<span class="sc">$</span>at_risk_adjusted</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Take the cumulative product of P to get the survivor function estimates with cumprod(P)</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co"># This is just to format things nicely:</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="fu">data.frame</span>(<span class="st">`</span><span class="at">time t</span><span class="st">`</span> <span class="ot">=</span> breaks, <span class="st">`</span><span class="at">S(t)</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">round</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="fu">cumprod</span>(P)), <span class="dv">3</span>),</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>                        <span class="at">check.names =</span> <span class="cn">FALSE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">time t</th>
<th style="text-align: right;">S(t)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.000</td>
</tr>
<tr class="even">
<td style="text-align: right;">200</td>
<td style="text-align: right;">0.676</td>
</tr>
<tr class="odd">
<td style="text-align: right;">400</td>
<td style="text-align: right;">0.390</td>
</tr>
<tr class="even">
<td style="text-align: right;">600</td>
<td style="text-align: right;">0.223</td>
</tr>
<tr class="odd">
<td style="text-align: right;">800</td>
<td style="text-align: right;">0.081</td>
</tr>
<tr class="even">
<td style="text-align: right;">1000</td>
<td style="text-align: right;">0.054</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1200</td>
<td style="text-align: right;">0.054</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>We have just shown here the “life table estimate” of the survivor function. Life tables such as those produced by the <a href="https://www.ons.gov.uk/peoplepopulationandcommunity/birthsdeathsandmarriages/lifeexpectancies/datasets/nationallifetablesunitedkingdomreferencetables">Office for National Statistics</a> typically present more information. For example, a life table may consider a cohort of size 100,000, and then list the number expected to be alive at the start of each period (obtained by multiplying <span class="math inline">\(S(t)\)</span> by 100,000 for each <span class="math inline">\(t\)</span>),</p>
</div>
</div>
</section>
<section id="kaplan-meier-estimate-of-st" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="kaplan-meier-estimate-of-st"><span class="header-section-number">2.3</span> Kaplan-Meier estimate of <span class="math inline">\(S(t)\)</span></h2>
<p>This is the most commonly reported estimate of a survivor function; you’ll see a Kaplan-Meier plot in just about any publication of clinical trial results involving survival data.</p>
<p>The Kaplan-Meier estimate requires individual survival/censoring times; it doesn’t work with grouped data, but, unlike the life table method, it provides an estimate of the function <span class="math inline">\(S(t)\)</span> for <span class="math inline">\(t\ge 0\)</span>.</p>
<p>We will first show how to construct the Kaplan-Meier estimate using an example. Suppose we have five patients and observe survival times of <span class="math inline">\(t=3, 4, 10, 12\)</span> for four of them, and have one censored observation at <span class="math inline">\(t=7\)</span> (so for the fifth patient, we only know their survival time exceeds 7).</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="survivor_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<ul>
<li><p>For <span class="math inline">\(0\le t &lt; 3\)</span>, everyone who is at risk is still alive, so we estimate <span class="math inline">\(\hat{S}(t) = 1\)</span> for <span class="math inline">\(0\le t &lt; 3\)</span>.</p></li>
<li><p>One of the five patients is not alive at time <span class="math inline">\(t=3\)</span>, so we estimate <span class="math inline">\(\hat{S}(3) = 4/5\)</span>.</p></li>
<li><p>For <span class="math inline">\(3\le t &lt; 4\)</span>, everyone who is at risk is still alive, so for <span class="math inline">\(3\le t &lt; 4\)</span> we use the factorisation approach in <a href="#sec-factorisation" class="quarto-xref"><span>Section 2.1.1</span></a> and estimate <span class="math display">\[
\hat{S}(t) = \hat{S}(3)\hat{P}(T\ge t|T\ge 3) = \frac{4}{5}\times 1
\]</span></p></li>
</ul>
<p><span class="math inline">\(\hat{S}(t) = 1\)</span> for <span class="math inline">\(0\le t &lt; 3\)</span>.</p>
<ul>
<li><p>For <span class="math inline">\(t=4\)</span> we again use the factorisation approach and write <span class="math display">\[
S(4) = S(3)P(T\ge 4|T\ge 3).
\]</span> We have <span class="math inline">\(\hat{S}(3)=4/5\)</span> as before, but now we note that, of the four patients alive at time <span class="math inline">\(t=3\)</span>, one was not alive at time <span class="math inline">\(t=4\)</span>, so we have the estimate <span class="math display">\[
\hat{S}(4) = \hat{S}(3)\hat{P}(T\ge 4|T\ge 3) = \frac{4}{5}\times \frac{3}{4} = \frac{3}{5}
\]</span></p></li>
<li><p>For <span class="math inline">\(4\le t &lt; 10\)</span>, we do not observe any <em>deaths</em> out of those patients at risk (though we have observed one censoring event), so for <span class="math inline">\(4\le t &lt; 10\)</span> we have <span class="math display">\[
\hat{S}(t) = \hat{S}(4)\hat{P}(T\ge t|T\ge 4) = \frac{3}{5}\times 1
\]</span></p></li>
<li><p>For <span class="math inline">\(t=10\)</span>, we could follow the same process as before and write <span class="math display">\[
S(10) = S(4)P(T\ge 10|T\ge 4),
\]</span> but this is awkward because of the censoring event at time <span class="math inline">\(t=7\)</span>. But in the factorisation method, we can condition on any time we like up to time <span class="math inline">\(t=10\)</span>. If we instead write <span class="math display">\[
S(10) = S(7)P(T\ge 10|T\ge 7),
\]</span> we can now handle the censoring more easily. We have <span class="math inline">\(\hat{S}(7)=3/5\)</span> from previously. From time <span class="math inline">\(t=7\)</span> onwards, there were two patients at risk, and one was alive at time <span class="math inline">\(t=10\)</span>. So we estimate <span class="math display">\[
\hat{S}(10) = \hat{S}(7)\hat{P}(T\ge 10|T\ge 7) = \frac{3}{5}\times \frac{1}{2} = \frac{3}{10}.
\]</span></p></li>
<li><p>Continuing this approach, we estimate <span class="math inline">\(\hat{S}(t) = 3/10\)</span> for <span class="math inline">\(10 \le t &lt; 12\)</span> and <span class="math inline">\(\hat{S}(t) = 0\)</span> for <span class="math inline">\(t\ge 12\)</span>.</p></li>
</ul>
<p>Tabulating the Kaplan-Meier estimate, we have</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: center;"><span class="math inline">\(t\)</span></th>
<th style="text-align: center;"><span class="math inline">\(\hat{S}(t)\)</span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1.0</td>
<td style="text-align: center;"><span class="math inline">\(0\le t &lt; 3\)</span></td>
</tr>
<tr class="even">
<td style="text-align: center;">0.8</td>
<td style="text-align: center;"><span class="math inline">\(3\le t &lt; 4\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: center;">0.6</td>
<td style="text-align: center;"><span class="math inline">\(4\le t &lt; 10\)</span></td>
</tr>
<tr class="even">
<td style="text-align: center;">0.3</td>
<td style="text-align: center;"><span class="math inline">\(10\le t &lt; 12\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: center;">0.0</td>
<td style="text-align: center;"><span class="math inline">\(12\le t\)</span></td>
</tr>
</tbody>
</table>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The Kaplan-Meier estimate is a step function:</p>
<ul>
<li>it decreases by some amount at every <em>observed</em> failure event</li>
<li>there is no decrease in the function at any <em>censoring</em> event, but we reduce the number of patients at risk in subsequent calculations.</li>
</ul>
</div>
</div>
<section id="general-notation-and-formula" class="level3" data-number="2.3.1">
<h3 data-number="2.3.1" class="anchored" data-anchor-id="general-notation-and-formula"><span class="header-section-number">2.3.1</span> General notation and formula</h3>
<p>We define</p>
<ul>
<li><p><span class="math inline">\(t_{(1)} &lt;t_{(2)} &lt; \ldots &lt;t_{(k)}\)</span> to be the <span class="math inline">\(k\)</span> distinct lifetimes with <span class="math inline">\(d_j\)</span> individuals failing at time <span class="math inline">\(t_{(j)}\)</span>. Note that these are times when we observe failure events only, not censoring;</p></li>
<li><p><span class="math inline">\(I_j\)</span> to be the number of individuals who were censored in the interval <span class="math inline">\(t_{(j-1)} \leq t &lt; t_{(j)}\)</span></p></li>
<li><p><span class="math inline">\(n\)</span> to be the total number of patients at the beginning of the study;</p></li>
<li><p><span class="math inline">\(r_j\)</span> to be the number of patients at risk just before time <span class="math inline">\(t_{(j)}\)</span>: the number of patients we are monitoring just before time <span class="math inline">\(t_{(j)}\)</span></p></li>
</ul>
<p>We then compute</p>
<p><span class="math display">\[\begin{align}
r_1 &amp;= n - I_1 \\
r_{j} &amp;= r_{j-1} - d_{j-1} - I_{j} \\
&amp;= n - (d_1 + d_2 + \ldots +d_{j-1})-(I_1+I_2+\ldots+I_{j}) \quad \textrm{for } j \geq 2
\end{align}\]</span> and the Kaplan-Meier estimate of <span class="math inline">\(S(t)\)</span> is given by <span class="math display">\[
\hat{S}(t) = \prod_{j=1}^s \left( 1 - \frac{d_j}{r_j} \right) \quad \textrm{for }  t_{(s)} \leq t  &lt; t_{(s+1)}
\]</span></p>
<p>If <span class="math inline">\(I_{k+1} &gt; 0\)</span> then <span class="math display">\[\hat{S}(t) = \prod_{j=1}^s \left( 1 - \frac{d_j}{r_j} \right) &gt; 0\]</span> since <span class="math inline">\(r_k &gt; d_k\)</span>. Hence if there are still individuals left in the trial after the last observed death (possibly as the observation period has ended) then <span class="math inline">\(\hat{S}(t)\)</span> will not tend to 0. However we know, by definition that as <span class="math inline">\(t \rightarrow \infty\)</span> then <span class="math inline">\(S(t) \rightarrow 0\)</span> since everyone will fail eventually, so the Kaplan-Meier estimate is biased if the maximum observation is censored.</p>
<p>We can also estimate <span class="math inline">\(H(t)\)</span> by <span class="math inline">\(\hat{H}(t)= -\log{\hat{S}(t)}\)</span> or we can use the simpler approximation <span class="math display">\[
\tilde{H}(t)= \sum_{j=1}^s \frac{d_j}{r_j} \quad \textrm{for }  t_{(s)} \leq t  &lt; t_{(s+1)}
\]</span></p>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Example: Tumour Remission Times
</div>
</div>
<div class="callout-body-container callout-body">
<p>A study investigates the remission times for 10 patients with tumours. During the study:</p>
<ul>
<li>six relapse after 3.0, 6.5, 6.5, 10, 12, and 15 months</li>
<li>and one was lost to follow-up at 8.4 months;</li>
<li>the other three were still in remission at end of study after 4.0, 5.7, 10.1 months respectively.</li>
</ul>
<p>We show this data in <a href="#tbl-TumourRemission" class="quarto-xref">Table&nbsp;<span>2.1</span></a> along with the Kaplan-Meier estimate of the survivor function.</p>
<div id="tbl-TumourRemission" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-TumourRemission-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;2.1: Kaplan-Meier Estimate of the Survivor Function for the Tumour Remission Times Data
</figcaption>
<div aria-describedby="tbl-TumourRemission-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 11%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;"><span class="math inline">\(j\)</span></th>
<th style="text-align: center;"><span class="math inline">\(t_{(j)}\)</span></th>
<th style="text-align: center;"><span class="math inline">\(I_j\)</span></th>
<th style="text-align: center;"><span class="math inline">\(r_j\)</span></th>
<th style="text-align: center;"><span class="math inline">\(d_j\)</span></th>
<th style="text-align: center;"><span class="math inline">\(\left(1-\frac{d_j}{r_j}\right)\)</span></th>
<th style="text-align: center;"><span class="math inline">\(\hat{S}(t)\)</span></th>
<th style="text-align: center;"><span class="math inline">\(t\)</span></th>
<th style="text-align: left;">Calculation of <span class="math inline">\(\hat{S}(t)\)</span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">1.00</td>
<td style="text-align: center;"><span class="math inline">\(0 \leq t &lt;3.0\)</span></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: center;">1</td>
<td style="text-align: center;">3.00</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">10</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">9/10</td>
<td style="text-align: center;">0.90</td>
<td style="text-align: center;"><span class="math inline">\(3.0 \leq t&lt;6.5\)</span></td>
<td style="text-align: left;">9/10</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2</td>
<td style="text-align: center;">6.50</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">7</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">5/7</td>
<td style="text-align: center;">0.64</td>
<td style="text-align: center;"><span class="math inline">\(6.5\leq t&lt;10.0\)</span></td>
<td style="text-align: left;"><span class="math inline">\(9/10 \times 5/7\)</span></td>
</tr>
<tr class="even">
<td style="text-align: center;">3</td>
<td style="text-align: center;">10.00</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">4</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">3/4</td>
<td style="text-align: center;">0.48</td>
<td style="text-align: center;"><span class="math inline">\(10.0\leq t&lt;12.0\)</span></td>
<td style="text-align: left;"><span class="math inline">\(9/10 \times 5/7 \times 3/4\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: center;">4</td>
<td style="text-align: center;">12.00</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1/2</td>
<td style="text-align: center;">0.24</td>
<td style="text-align: center;"><span class="math inline">\(12.0\leq t&lt;15.0\)</span></td>
<td style="text-align: left;"><span class="math inline">\(9/10 \times 5/7 \times 3/4 \times 1/2\)</span></td>
</tr>
<tr class="even">
<td style="text-align: center;">5</td>
<td style="text-align: center;">15.00</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0.00</td>
<td style="text-align: center;"><span class="math inline">\(15\leq t\)</span></td>
<td style="text-align: left;"></td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</div>
</div>
</section>
<section id="finding-the-median-survival-time-from-km-plots" class="level3" data-number="2.3.2">
<h3 data-number="2.3.2" class="anchored" data-anchor-id="finding-the-median-survival-time-from-km-plots"><span class="header-section-number">2.3.2</span> Finding the Median Survival Time from KM plots</h3>
<p>The median, <span class="math inline">\(M\)</span>, is defined as <span class="math display">\[
M = \mathop{\mathrm{argmin}}_t \{ S(t) \leq 0.5\},
\]</span> i.e.&nbsp;it is the smallest value of <span class="math inline">\(t\)</span> where the survivor function takes a value of 0.5 or less.</p>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Example: Tumour Remission Times continued
</div>
</div>
<div class="callout-body-container callout-body">
<p>We can see from <a href="#tbl-TumourRemission" class="quarto-xref">Table&nbsp;<span>2.1</span></a> that <span class="math inline">\(\hat{S}(t) &gt; 0.5\)</span> for <span class="math inline">\(0 \leq t &lt; 10\)</span> and <span class="math inline">\(\hat{S}(10)\leq 0.5\)</span> so that the median tumour remission time is 10 months.</p>
</div>
</div>
</section>
<section id="variance-of-the-kaplan-meier-estimator" class="level3" data-number="2.3.3">
<h3 data-number="2.3.3" class="anchored" data-anchor-id="variance-of-the-kaplan-meier-estimator"><span class="header-section-number">2.3.3</span> Variance of the Kaplan-Meier estimator</h3>
<p><span class="math inline">\(\hat{S}(t)\)</span> is subject to sampling error. The Greenwood estimate of the variance is</p>
<p><span class="math display">\[
var\left( \hat{S}(t) \right) \simeq \left( \hat{S}(t) \right)^2 \sum_{j=1}^{s} \frac{d_j}{r_j(r_j-d_j)} \quad \textrm{for }  t_{(s)} \leq t  &lt; t_{(s+1)}
\]</span></p>
</section>
<section id="RKMEst" class="level3" data-number="2.3.4">
<h3 data-number="2.3.4" class="anchored" data-anchor-id="RKMEst"><span class="header-section-number">2.3.4</span> Calculating Kaplan-Meier Estimates in R</h3>
<ul>
<li><p><code>R</code> functions for analysing survival data are in the <code>survival</code> package. You shouldn’t need to install it as it is included in the basic installation of R.</p></li>
<li><p>The first step is to create a <em>survival object</em> with the function <code>Surv()</code> (note the capital S). It contains information on which observations are censored (coded with a <code>0</code>) and which are observed events (coded with a <code>1</code>).</p></li>
<li><p>The next step is to estimate the survivor curve with the function <code>survfit()</code>.</p></li>
<li><p>To produce flexible Kaplan-Meier plots use the <code>ggsurvplot</code> function in the <code>survminer</code> package (install and load it as above). The function <code>summary()</code> will give the estimate of the survivor function and other details of the model fitting.</p></li>
</ul>
<p>We will create the data frame from scratch. The analysis can be performed as described below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>tumour <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">time =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="fl">6.5</span>, <span class="fl">6.5</span>, <span class="dv">10</span>, <span class="dv">12</span>, <span class="dv">15</span>, <span class="fl">8.4</span>, <span class="dv">4</span>, <span class="fl">5.7</span>, <span class="fl">10.1</span>),</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>                     <span class="at">censor =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survminer)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>tumour <span class="co"># 0 means censored, 1 means observed</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   time censor
1   3.0      1
2   6.5      1
3   6.5      1
4  10.0      1
5  12.0      1
6  15.0      1
7   8.4      0
8   4.0      0
9   5.7      0
10 10.1      0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>tumour_sv <span class="ot">&lt;-</span> <span class="fu">Surv</span>(tumour<span class="sc">$</span>time, tumour<span class="sc">$</span>censor, <span class="at">type =</span> <span class="st">"right"</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>tumourSurv <span class="ot">&lt;-</span><span class="fu">survfit</span>(tumour_sv <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data=</span>tumour)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(tumourSurv)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call: survfit(formula = tumour_sv ~ 1, data = tumour)

 time n.risk n.event survival std.err lower 95% CI upper 95% CI
  3.0     10       1    0.900  0.0949       0.7320            1
  6.5      7       2    0.643  0.1679       0.3852            1
 10.0      4       1    0.482  0.1877       0.2248            1
 12.0      2       1    0.241  0.1946       0.0496            1
 15.0      1       1    0.000     NaN           NA           NA</code></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsurvplot</span>(tumourSurv, </span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> tumour_sv,</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">surv.median.line =</span> <span class="st">'hv'</span>,</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">conf.int =</span> <span class="cn">TRUE</span>, </span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">conf.int.style =</span> <span class="st">"ribbon"</span>,</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">conf.int.alpha =</span> <span class="fl">0.4</span>,</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">xlab =</span> <span class="st">"Time (months)"</span>, </span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>           <span class="at">risk.table =</span> T,</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>           <span class="at">break.time.by =</span> <span class="dv">1</span>,</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>           <span class="at">ncensor.plot =</span> T,</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>           <span class="at">color =</span> <span class="st">"black"</span>, </span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>           <span class="at">censor =</span> T,</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>           <span class="at">censor.shape =</span> <span class="dv">3</span>,</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>           <span class="at">censor.size =</span> <span class="dv">5</span>,</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>           <span class="at">tables.height =</span> <span class="fl">0.25</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="survivor_files/figure-html/KMTumour-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Kaplan-Meier Estimate of the survivor function for the Tumour Remission Times data</figcaption>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>There are lots of arguments you can specify in the <code>ggsurvplot</code> function. The minimum you need in the above example would be</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsurvplot</span>(tumourSurv, <span class="at">data =</span> tumour_sv)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note also that this creates a <code>ggplot2</code> object that you can customise with other <code>ggplot2</code> commands. To access this you would do</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>KMplot <span class="ot">&lt;-</span> <span class="fu">ggsurvplot</span>(tumourSurv, <span class="at">data =</span> tumour_sv)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>KM<span class="sc">$</span>plot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="tasks" class="level2" data-number="2.4">
<h2 data-number="2.4" class="anchored" data-anchor-id="tasks"><span class="header-section-number">2.4</span> Tasks</h2>
<ol type="1">
<li>Derive the life table estimate of the survival function for patients with angina pectoris, using the data given below. (To shorten the question, data are only given for the first five years of survival.)</li>
</ol>
<table class="caption-top table">
<colgroup>
<col style="width: 32%">
<col style="width: 35%">
<col style="width: 32%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Survival time (years)</th>
<th style="text-align: center;">Number of patients known to survive at beginning of interval</th>
<th style="text-align: center;">Number of patients lost to follow up</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">0 - 1</td>
<td style="text-align: center;">2418</td>
<td style="text-align: center;">0</td>
</tr>
<tr class="even">
<td style="text-align: center;">1 - 2</td>
<td style="text-align: center;">1962</td>
<td style="text-align: center;">39</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2 - 3</td>
<td style="text-align: center;">1697</td>
<td style="text-align: center;">22</td>
</tr>
<tr class="even">
<td style="text-align: center;">3 - 4</td>
<td style="text-align: center;">1523</td>
<td style="text-align: center;">23</td>
</tr>
<tr class="odd">
<td style="text-align: center;">4 - 5</td>
<td style="text-align: center;">1329</td>
<td style="text-align: center;">24</td>
</tr>
</tbody>
</table>
<ol start="2" type="1">
<li>The data below give the time to relapse (in weeks), following remission, for a group of leukaemia patients treated with a particular drug: (* indicates a right censored value).</li>
</ol>
<p><span class="math display">\[6^*, 6, 6, 6, 7, 9^*, 10^*, 10, 11^*, 13, 16,\]</span> <span class="math display">\[17^*, 19^*, 20^*, 22, 23, 25^*, 32^*, 34^*, 35^*\]</span></p>
<ol type="a">
<li><p>Tabulate the Kaplan-Meier estimate of the survivor function. Sketch the estimated survivor function.</p></li>
<li><p>Estimate the median time to relapse.</p></li>
<li><p>Estimate the proportion of patients that will not relapse within 6 weeks of starting remission.</p></li>
<li><p>Use R to verify your table and plot. Note that the following code will set up the data in R:</p></li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>leukemia <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">time =</span> <span class="fu">c</span>(<span class="dv">6</span>, <span class="dv">6</span>, <span class="dv">6</span>, <span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">9</span>, <span class="dv">10</span>,</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>                                <span class="dv">10</span>, <span class="dv">11</span>, <span class="dv">13</span>, <span class="dv">16</span>, <span class="dv">17</span>, <span class="dv">19</span>,</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>                                <span class="dv">20</span>, <span class="dv">22</span>, <span class="dv">23</span>, <span class="dv">25</span>, <span class="dv">32</span>, <span class="dv">32</span>,</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>                                <span class="dv">34</span>, <span class="dv">35</span>),</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">censor =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>,</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>                                  <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>,</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>                                  <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="5" type="a">
<li>Comment on the estimated survivor function for <span class="math inline">\(t&gt;25\)</span> weeks: whether you think the estimate is reliable or not.</li>
</ol>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-12-contents" aria-controls="callout-12" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-12" class="callout-12-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ol type="1">
<li>We proceed by finding the number who died in the first interval <span class="math inline">\(2418-1962 = 456\)</span>; in the second interval <span class="math inline">\(1962-39-1697=226\)</span> and so on. We tabulate and add in the adjusted number at risk</li>
</ol>
<table class="caption-top table">
<colgroup>
<col style="width: 20%">
<col style="width: 22%">
<col style="width: 20%">
<col style="width: 18%">
<col style="width: 18%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Survival time (years)</th>
<th style="text-align: center;">Number of patients known to survive at beginning of interval</th>
<th style="text-align: center;">Number of patients lost to follow up</th>
<th style="text-align: right;">Number of deaths</th>
<th style="text-align: right;">Adjusted number at risk</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">0 - 1</td>
<td style="text-align: center;">2418</td>
<td style="text-align: center;">0</td>
<td style="text-align: right;">456</td>
<td style="text-align: right;">2418.0</td>
</tr>
<tr class="even">
<td style="text-align: center;">1 - 2</td>
<td style="text-align: center;">1962</td>
<td style="text-align: center;">39</td>
<td style="text-align: right;">226</td>
<td style="text-align: right;">1942.5</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2 - 3</td>
<td style="text-align: center;">1697</td>
<td style="text-align: center;">22</td>
<td style="text-align: right;">152</td>
<td style="text-align: right;">1686.0</td>
</tr>
<tr class="even">
<td style="text-align: center;">3 - 4</td>
<td style="text-align: center;">1523</td>
<td style="text-align: center;">23</td>
<td style="text-align: right;">171</td>
<td style="text-align: right;">1511.5</td>
</tr>
<tr class="odd">
<td style="text-align: center;">4 - 5</td>
<td style="text-align: center;">1329</td>
<td style="text-align: center;">24</td>
<td style="text-align: right;">135</td>
<td style="text-align: right;">1317.0</td>
</tr>
</tbody>
</table>
<p>The life-table estimate is computed as</p>
<table class="caption-top table">
<colgroup>
<col style="width: 25%">
<col style="width: 27%">
<col style="width: 25%">
<col style="width: 22%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;"><span class="math inline">\(j\)</span></th>
<th style="text-align: center;"><span class="math inline">\(t_j\)</span></th>
<th style="text-align: center;"><span class="math inline">\(\hat{P}(T\ge t_j | T\ge t_{j-1})\)</span></th>
<th style="text-align: right;"><span class="math inline">\(\hat{S}(t_j) = \hat{S}(t_{j-1})\times\hat{P}(T\ge t_j | T\ge t_{j-1})\)</span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">-</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;"><span class="math inline">\((2418-456)/2418\)</span></td>
<td style="text-align: right;"><span class="math inline">\(0.81\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: center;">3</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;"><span class="math inline">\((1942.5-226)/1942.5\)</span></td>
<td style="text-align: right;"><span class="math inline">\(0.72\)</span></td>
</tr>
<tr class="even">
<td style="text-align: center;">4</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;"><span class="math inline">\((1686.0-152)/1686.0\)</span></td>
<td style="text-align: right;"><span class="math inline">\(0.64\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: center;">5</td>
<td style="text-align: center;">4</td>
<td style="text-align: center;"><span class="math inline">\((1511.5-171)/1511.5\)</span></td>
<td style="text-align: right;"><span class="math inline">\(0.57\)</span></td>
</tr>
<tr class="even">
<td style="text-align: center;">6</td>
<td style="text-align: center;">5</td>
<td style="text-align: center;"><span class="math inline">\((1317.0-135)/1317.0\)</span></td>
<td style="text-align: right;"><span class="math inline">\(0.50\)</span></td>
</tr>
</tbody>
</table>
<ol start="2" type="1">
<li>The R code below is the solution to part d, and also gives the Kaplan-Meier estimate and plot for part a.</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>leukemia <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">time =</span> <span class="fu">c</span>(<span class="dv">6</span>, <span class="dv">6</span>, <span class="dv">6</span>, <span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">9</span>, <span class="dv">10</span>,</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>                                <span class="dv">10</span>, <span class="dv">11</span>, <span class="dv">13</span>, <span class="dv">16</span>, <span class="dv">17</span>, <span class="dv">19</span>,</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>                                <span class="dv">20</span>, <span class="dv">22</span>, <span class="dv">23</span>, <span class="dv">25</span>, <span class="dv">32</span>, <span class="dv">32</span>,</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>                                <span class="dv">34</span>, <span class="dv">35</span>),</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">censor =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>,</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>                                  <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>,</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>                                  <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survminer)</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>leukemia_sv <span class="ot">&lt;-</span> <span class="fu">Surv</span>(leukemia<span class="sc">$</span>time, leukemia<span class="sc">$</span>censor, <span class="at">type =</span> <span class="st">"right"</span>)</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>leukemiaSurv <span class="ot">&lt;-</span><span class="fu">survfit</span>(leukemia_sv <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data=</span>leukemia)</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(leukemiaSurv)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call: survfit(formula = leukemia_sv ~ 1, data = leukemia)

 time n.risk n.event survival std.err lower 95% CI upper 95% CI
    6     21       3    0.857  0.0764        0.720        1.000
    7     17       1    0.807  0.0869        0.653        0.996
   10     15       1    0.753  0.0963        0.586        0.968
   13     12       1    0.690  0.1068        0.510        0.935
   16     11       1    0.627  0.1141        0.439        0.896
   22      7       1    0.538  0.1282        0.337        0.858
   23      6       1    0.448  0.1346        0.249        0.807</code></pre>
</div>
</div>
<p>To get the plot we do</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsurvplot</span>(leukemiaSurv, <span class="at">data =</span> leukemia,</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">surv.median.line =</span> <span class="st">'hv'</span>,</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">xlab =</span> <span class="st">"Remission Time (Weeks)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="survivor_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<ol start="2" type="a">
<li><p>For the median we need the smallest <span class="math inline">\(t\)</span> for which the estimated survivor function <span class="math inline">\(S(t)\le0.5\)</span>. We can read this off the table as <span class="math inline">\(t=23\)</span>.</p></li>
<li><p>The the proportion of patients that will not relapse within 6 weeks of starting remission is <span class="math inline">\(S(6)\)</span>. From the table, this is estimated as 0.857.</p></li>
<li><p>For <span class="math inline">\(t&gt;25\)</span> we see in the plot that the confidence intervals for <span class="math inline">\(\hat{S}(t)\)</span> are wide, and we also note all observations for <span class="math inline">\(t&gt;25\)</span> are censored. The estimate of <span class="math inline">\(S(t)\)</span> may not very reliable here. A ‘flat’ survivor function as seen for <span class="math inline">\(t&gt;23\)</span> may not be plausible, unless it is the case that if remission has not occurred after a certain number of weeks, it is unlikely to occur at all.</p></li>
</ol>
</div>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./background.html" class="pagination-link" aria-label="Background and Basic Concepts">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Background and Basic Concepts</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./parametric.html" class="pagination-link" aria-label="Parametric one-sample models">
        <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Parametric one-sample models</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>