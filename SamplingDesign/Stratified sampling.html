<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>11&nbsp; Stratified Sampling – MPS318/4101 Sampling Theory and Design of Experiments</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./Population size.html" rel="next">
<link href="./Sample sizes and confidence intervals.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-27c261d06b905028a18691de25d09dde.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./Introduction to sampling.html">Part II: Sampling Theory</a></li><li class="breadcrumb-item"><a href="./Stratified sampling.html"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Stratified Sampling</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="./index.html" class="sidebar-logo-link">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="./">MPS318/4101 Sampling Theory and Design of Experiments</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Instructions</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Part I: Experimental Design</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Introduction to experimental design.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction to Experimental Design</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Review of linear models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">A review of linear models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Optimality.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Optimality criteria</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Qualitative-single factor.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Qualitative explanatory variables and blocking</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Qualitative-multiple factors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Latin Square designs</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Factorial designs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Factorial designs</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Continuous and exact designs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Continuous and exact designs</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Part II: Sampling Theory</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Introduction to sampling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Introduction to Sampling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Simple random sampling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Simple Random Sampling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Sample sizes and confidence intervals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Confidence intervals and sample sizes</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Stratified sampling.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Stratified Sampling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Population size.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Estimating a Population Size</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Practicalities.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Reliability of sample surveys</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Part III: self-study topics for MPS4101</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Tailor-made designs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Modifying designs</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Cluster sampling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Cluster Sampling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Introduction-computer-experiments.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Introduction to computer experiments</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Uncertainty-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Uncertainty analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Sensitivity-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Sensitivity analysis</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#notation" id="toc-notation" class="nav-link active" data-scroll-target="#notation"><span class="header-section-number">11.1</span> Notation</a></li>
  <li><a href="#estimation-of-overlinex" id="toc-estimation-of-overlinex" class="nav-link" data-scroll-target="#estimation-of-overlinex"><span class="header-section-number">11.2</span> Estimation of <span class="math inline">\(\overline{X}\)</span></a></li>
  <li><a href="#sec-stratvsrs" id="toc-sec-stratvsrs" class="nav-link" data-scroll-target="#sec-stratvsrs"><span class="header-section-number">11.3</span> Stratification vs SRS</a></li>
  <li><a href="#choice-of-sample-sizes-n-n_1dotsn_l" id="toc-choice-of-sample-sizes-n-n_1dotsn_l" class="nav-link" data-scroll-target="#choice-of-sample-sizes-n-n_1dotsn_l"><span class="header-section-number">11.4</span> Choice of Sample Sizes <span class="math inline">\(n, n_1,\dots,n_l\)</span></a></li>
  <li><a href="#multilevel-regression-and-post-stratification-mrp" id="toc-multilevel-regression-and-post-stratification-mrp" class="nav-link" data-scroll-target="#multilevel-regression-and-post-stratification-mrp"><span class="header-section-number">11.5</span> Multilevel regression and post-stratification (MRP)</a>
  <ul class="collapse">
  <li><a href="#example" id="toc-example" class="nav-link" data-scroll-target="#example"><span class="header-section-number">11.5.1</span> Example</a></li>
  </ul></li>
  <li><a href="#tasks" id="toc-tasks" class="nav-link" data-scroll-target="#tasks"><span class="header-section-number">11.6</span> Tasks</a></li>
  <li><a href="#appendix-proofs" id="toc-appendix-proofs" class="nav-link" data-scroll-target="#appendix-proofs"><span class="header-section-number">11.7</span> Appendix: proofs</a>
  <ul class="collapse">
  <li><a href="#proof-that-barx_st-is-the-best-linear-unbiased-estimator" id="toc-proof-that-barx_st-is-the-best-linear-unbiased-estimator" class="nav-link" data-scroll-target="#proof-that-barx_st-is-the-best-linear-unbiased-estimator"><span class="header-section-number">11.7.1</span> Proof that <span class="math inline">\(\bar{x}_{st}\)</span> is the best linear unbiased estimator</a></li>
  <li><a href="#stratification-vs-srs" id="toc-stratification-vs-srs" class="nav-link" data-scroll-target="#stratification-vs-srs"><span class="header-section-number">11.7.2</span> Stratification vs SRS</a></li>
  </ul></li>
  <li><a href="#appendix-sample-size-choices" id="toc-appendix-sample-size-choices" class="nav-link" data-scroll-target="#appendix-sample-size-choices"><span class="header-section-number">11.8</span> Appendix: sample size choices</a>
  <ul class="collapse">
  <li><a href="#minimising-variance-within-a-fixed-cost." id="toc-minimising-variance-within-a-fixed-cost." class="nav-link" data-scroll-target="#minimising-variance-within-a-fixed-cost."><span class="header-section-number">11.8.1</span> Minimising Variance Within a Fixed Cost.</a></li>
  <li><a href="#special-case-c_i-constant." id="toc-special-case-c_i-constant." class="nav-link" data-scroll-target="#special-case-c_i-constant."><span class="header-section-number">11.8.2</span> Special Case: <span class="math inline">\(c_i\)</span> constant.</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./Introduction to sampling.html">Part II: Sampling Theory</a></li><li class="breadcrumb-item"><a href="./Stratified sampling.html"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Stratified Sampling</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span id="stratifiedsampling" class="quarto-section-identifier"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Stratified Sampling</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="callout callout-style-default callout-caution no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Caution</span>Aims for this chapter
</div>
</div>
<div class="callout-body-container callout-body">
<p>In this chapter we introduce the idea of stratification: dividing the population into groups or “strata”. We take samples from each group, estimate the quantity of interest in each group, then combine the estimates to get an estimate for the population. In particular we</p>
<ol type="1">
<li><p>set out the basic theory and notation for stratified sampling;</p></li>
<li><p>consider when stratified sampling will be more efficient (lower variance) than SRS;</p></li>
<li><p>introduce multilevel regression and post-stratification (MRP) as a modelling technique that is used with survey data.</p></li>
</ol>
</div>
</div>
<p>The requirement for simple random sampling is that all possible samples are equally likely to be drawn. In practice, this can be difficult to achieve, particularly when we are sampling people rather than, say, items in a warehouse. Some people are harder to reach and/or are less likely to participate in surveys than others. Additionally, there are often relevant groupings in a population, e.g.&nbsp;different regions of the country supporting different political parties. If a grouping of ‘similar’ individuals coincides with grouping of individuals that are harder to reach or less likely to take part in a survey, a sample may be biased.</p>
<p>Two strategies to deal with this are:</p>
<ol type="1">
<li><p>when planning the survey, identify relevant subgroups of the population, and ensure suitable samples are drawn <em>within</em> each subgroup, then combine the results from each subgroup in an appropriate way. This is <strong>stratified</strong> sampling.</p></li>
<li><p>After the sample has been taken, apply a weighting of the observations in a such a way to make the sample more representative of the population. This is called <strong>stratification after sampling</strong> or <strong>post-stratification</strong>.</p></li>
</ol>
<section id="notation" class="level2" data-number="11.1">
<h2 data-number="11.1" class="anchored" data-anchor-id="notation"><span class="header-section-number">11.1</span> Notation</h2>
<p>We refer to a group within a population as a <strong>stratum</strong> (plural: strata), for example, if the population is all adults in the UK, the strata could be the counties in the UK.</p>
<p>Suppose there are <span class="math inline">\(l\)</span> strata, with sizes <span class="math inline">\(N_i, i=1,\dots,l\)</span>, so that <span class="math inline">\(\sum_1^lN_i=N\)</span>. Members of <span class="math inline">\(i\)</span>th stratum denoted by <span class="math inline">\(X_{i,j}, j=1,\dots,N_i\)</span>.</p>
<p>The population mean of the <span class="math inline">\(i\)</span>th stratum is <span class="math inline">\(\overline{X}_i\)</span> and its variance is <span class="math display">\[S_i^2=\frac{1}{N_i-1} \sum_{j=1}^{N_i}(X_{i,j}-\overline{X}_i)^2.\]</span> Then the population mean is <span class="math display">\[\overline{X}=\frac{1}{N}\sum_{i=1}^l\sum_{j=1}^{N_i}X_{i,j}=\sum_{i=1}^l\frac{N_i}{N}\overline{X}_i,\]</span> is a weighted mean of the stratum means <span class="math inline">\(\overline{X}_i\)</span>, and <span class="math display">\[
S^2 =\frac{1}{N-1} \sum_{i=1}^l
\sum_{j=1}^{N_i}(X_{i,j}-\overline{X})^2\]</span></p>
<p><span id="eq-VarianceDecomp"><span class="math display">\[= \frac{1}{N-1} \left\{\sum_{i=1}^l (N_i-1)S_i^2+\sum_{i=1}^lN_i (\overline{X}_i - \overline{X})^2 \right\} \tag{11.1}\]</span></span> where inside the curly brackets we have a decomposition of the total sum of squares of the population values about their mean into a pooled within-stratum sum of squares and a between-strata sum of squares, identical algebraically to that found in the one-way analysis of variance. We will use this result in <a href="#sec-stratvsrs" class="quarto-xref"><span>Section 11.3</span></a>.</p>
<p>Suppose we draw a SRS of size <span class="math inline">\(n_i\)</span> from the <span class="math inline">\(i\)</span>th stratum, for <span class="math inline">\(i=1,\dots,l\)</span>. Let <span class="math inline">\(n=\sum_1^l n_i\)</span> denote the size of the combined sample, and <span class="math inline">\(f_i=n_i/N_i\)</span> the sampling fraction for stratum <span class="math inline">\(i\)</span>, <span class="math inline">\(i=1,\dots,l\)</span>. Let <span class="math inline">\(x_{ij}, j=1,\dots,n_i\)</span> denote the observations from the SRS from stratum <span class="math inline">\(i\)</span>, and <span class="math inline">\(\overline{x}_i, s_i^2\)</span> the corresponding sample mean and variance. Initially we take <span class="math inline">\(n\)</span> and the <span class="math inline">\(n_i\)</span> to be fixed.</p>
</section>
<section id="estimation-of-overlinex" class="level2" data-number="11.2">
<h2 data-number="11.2" class="anchored" data-anchor-id="estimation-of-overlinex"><span class="header-section-number">11.2</span> Estimation of <span class="math inline">\(\overline{X}\)</span></h2>
<p>The overall sample mean <span class="math inline">\(\overline{x}^\prime = \sum_i\sum_j x_{ij}/n = \sum_i n_i \overline{x}_i/n\)</span> has expectation <span class="math display">\[E(\overline{x}^\prime )=\frac{1}{n} \sum_1^l n_i \overline{X}_i\]</span> evidently equal to <span class="math inline">\(\overline{X}\)</span> if <span class="math inline">\(n_i = nN_i/N\)</span>, and so <span class="math inline">\(\overline{x}^\prime\)</span> in general <em>is biased for</em> <span class="math inline">\(\overline{X}\)</span>, except if <span class="math inline">\(f_i = \mbox{constant} = n/N\)</span>, the so-called <strong>proportional allocation</strong> of sampling effort (the size of the SRS from each stratum is proportional to the stratum size).</p>
<p>This suggests a better unbiased estimate, the stratified estimate using <strong>proportional allocation</strong>: <span id="eq-xbarst"><span class="math display">\[\overline{x}_{st} = \frac{1}{N} \sum_1^l N_i \overline{x}_i. \tag{11.2}\]</span></span></p>
<p>It can be proved that whatever the <span class="math inline">\(n_i,i=1,\dots,l\)</span>, under SSRS <span class="math inline">\(\overline{x}_{st}\)</span> is the best linear unbiased estimator (BLUE) of <span class="math inline">\(\overline{X}\)</span>, and it has variance <span id="eq-VarSRSS"><span class="math display">\[
\mbox{var}(\overline{x}_{st}) = \sum_1^l\left(\frac{N_i}{N}\right)^2\frac{1-f_i}{n_i} S_i^2.
\tag{11.3}\]</span></span> Deriving the variance is left as a task at the end of this chapter. The proof of BLUE is given in the appendix.</p>
<p>Usually the stratum population variances <span class="math inline">\(S_i^2\)</span> are unknown, and so they are estimated by the corresponding stratum sample variances <span class="math inline">\(s_i^2\)</span>, which by SRS are unbiased. Confidence intervals for <span class="math inline">\(\overline{X}\)</span> may then be based on a normal approximation: an approximate 95% confidence interval is</p>
<p><span class="math display">\[
\overline{x}_{st}\pm 1.96 \sqrt{\widehat{var}(\overline{x}_{st})},
\]</span> where <span class="math inline">\(\widehat{var}(\overline{x}_{st})\)</span> is obtained by estimating each <span class="math inline">\(S_i^2\)</span> by the corresponding sample variance <span class="math inline">\(s_i^2\)</span>.</p>
</section>
<section id="sec-stratvsrs" class="level2" data-number="11.3">
<h2 data-number="11.3" class="anchored" data-anchor-id="sec-stratvsrs"><span class="header-section-number">11.3</span> Stratification vs SRS</h2>
<p>When is <span class="math inline">\(\overline{x}_{st}\)</span> better than <span class="math inline">\(\overline{x}\)</span> from SRS? Both are unbiased, and so we compare variances. A proof is given in the appendix that <span class="math inline">\(\mbox{var}(\overline{x})\geq\mbox{var}(\overline{x}_{st})\)</span> requires <span id="eq-SRSvSSRS"><span class="math display">\[
\sum N_i(\overline{X}_i - \overline{X})^2 \geq\sum \left(1-\frac{N_i}{N}\right) S_i^2.
\tag{11.4}\]</span></span></p>
<p>The term on the left hand side is the between-strata sum of squares, and the one on the right hand side is a measure of the within-stratum variance. Thus <span class="math inline">\(\overline{x}_{st}\)</span> will have smaller variance than <span class="math inline">\(\overline{x}\)</span>, i.e.&nbsp;SSRS will be preferable to SRS, when the strata are homogeneous (small within-stratum variance) but well-separated (large difference between stratum means).</p>
</section>
<section id="choice-of-sample-sizes-n-n_1dotsn_l" class="level2" data-number="11.4">
<h2 data-number="11.4" class="anchored" data-anchor-id="choice-of-sample-sizes-n-n_1dotsn_l"><span class="header-section-number">11.4</span> Choice of Sample Sizes <span class="math inline">\(n, n_1,\dots,n_l\)</span></h2>
<p>This is more complicated, as we have to consider both the total sample size <span class="math inline">\(n\)</span>, and sample sizes within each strata. Recall that <span class="math display">\[
\mbox{var}(\overline{x}_{st}) = \left(\frac{N_1}{N}\right)^2\frac{1-f_1}{n_1} S_1^2+\ldots +\left(\frac{N_l}{N}\right)^2\frac{1-f_l}{n_l} S_l^2.
\]</span> We see that there is a contribution to <span class="math inline">\(\mbox{var}(\overline{x}_{st})\)</span> from each strata, which depends on</p>
<ul>
<li>the strata sample size <span class="math inline">\(n_i\)</span>;</li>
<li>the strata population size <span class="math inline">\(N_i\)</span>;</li>
<li>the strata population variance <span class="math inline">\(S_i^2\)</span>.</li>
</ul>
<p>In the appendix, methods are given for choosing sample sizes, but these depend on knowing all the strata population variances. A simpler approach is to</p>
<ol type="1">
<li>choose the overall sample size <span class="math inline">\(n\)</span> as if we were taking a simple random sample, as in <a href="Sample sizes and confidence intervals.html#sec-sampleSizeMean" class="quarto-xref"><span>Section 10.3</span></a>;</li>
<li>choose each strata sample size based on its size relative to the population: set <span class="math display">\[
n_i = n \frac{N_i}{N}.
\]</span></li>
</ol>
<p>As before, the larger the samples within strata, the more precise the estimation. However there is usually a cost associated with sampling that inhibits use of very large samples. The best values will depend therefore on the detailed costs of sampling in relation to the value of precision of estimation. The following captures the main features of many cases, at least approximately.</p>
</section>
<section id="multilevel-regression-and-post-stratification-mrp" class="level2" data-number="11.5">
<h2 data-number="11.5" class="anchored" data-anchor-id="multilevel-regression-and-post-stratification-mrp"><span class="header-section-number">11.5</span> Multilevel regression and post-stratification (MRP)</h2>
<p>MRP is a technique used in large surveys such as UK opinion polls and the Covid infection survey. The two main purposes of MRP are to adjust for a sample that may not appropriately represent the population, and to provide estimates for individual strata, even if these have not been sampled directly. For example, in political opinion polls, MRP is used to give voting intentions within each constituency, as well as for the UK as a whole.</p>
<p>An overview of the method is as follows</p>
<ul>
<li><p>We first draw a sample from the population. Whilst we may attempt to make the sample as representative as we can, the sample may under-represent some groups, e.g.&nbsp;because of ease of access or willingness to participate.</p></li>
<li><p>In addition to obtaining the quantity of interest for each sampled member, we also record covariates (e.g.&nbsp;age, home location, employment status) for the sampled member</p></li>
<li><p>Stratum are defined according to covariates: a particular combination of covariate values could make up a strata.</p></li>
<li><p>We use regression (typically a linear model or a logistic regression model) to estimate the relationship between the main quantity of interest and the other covariates</p></li>
<li><p>The regression model involves random effects/multilevel modelling/hierarchical modelling to help estimate quantities for particular strata, even if the sample size within that strata is small</p></li>
</ul>
<section id="example" class="level3" data-number="11.5.1">
<h3 data-number="11.5.1" class="anchored" data-anchor-id="example"><span class="header-section-number">11.5.1</span> Example</h3>
<p>To illustrate MRP, we will use simplified example with a made-up dataset. We suppose an opinion poll has been conducted to estimate support for the UK rejoining the European Union. We suppose a sample of 500 adults has been taken, and one covariate has been measured:</p>
<ul>
<li>region, categorised as “South England”, “North England”, “Wales”, “Scotland” or “Northern Ireland”.</li>
</ul>
<p>We define 5 stratum as these regions. The sizes <span class="math inline">\(N_i\)</span> are given below, counted in millions:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>census <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/census.csv"</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>census</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 2
  region             N_i
  &lt;chr&gt;            &lt;dbl&gt;
1 South England     25  
2 North England     15  
3 Wales              3  
4 Scotland           5.5
5 Northern Ireland   1.9</code></pre>
</div>
</div>
<p>Survey data for the eight participants (out of 500) are shown below.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>survey <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/survey.csv"</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(survey, <span class="at">n =</span> <span class="dv">8</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 8 × 2
  region        rejoin
  &lt;chr&gt;          &lt;dbl&gt;
1 North England      0
2 North England      0
3 Scotland           1
4 Wales              0
5 South England      0
6 Scotland           0
7 South England      1
8 Scotland           1</code></pre>
</div>
</div>
<p>Each row is the observation for one participant and in column <code>rejoin</code>, a 1 in indicates that the participant is in favour of rejoining; 0 indicates they are not in favour.</p>
<p>To get the sample proportion in favour of rejoining we do:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(survey<span class="sc">$</span>rejoin)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.646</code></pre>
</div>
</div>
<p>so about 65% in the survey are in favour of rejoining.</p>
<p>We now look at sample sizes for the five strata, and proportions in favour of rejoining within each strata.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>survey_proportions <span class="ot">&lt;-</span> survey <span class="sc">%&gt;%</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(region) <span class="sc">%&gt;%</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">prop_rejoin =</span> <span class="fu">mean</span>(rejoin),</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_i =</span> <span class="fu">n</span>(), <span class="co"># Optional: includes the number of respondents per cell</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Join with the census data frame so we can compare strata population sizes</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>combined <span class="ot">&lt;-</span> <span class="fu">inner_join</span>(census, survey_proportions,</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>                       <span class="at">by =</span> <span class="st">"region"</span>)</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="co"># View the result and arrange the rows in decreasing order of strata</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="co"># population size</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>combined <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(<span class="fu">desc</span>(N_i))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 4
  region             N_i prop_rejoin   n_i
  &lt;chr&gt;            &lt;dbl&gt;       &lt;dbl&gt; &lt;int&gt;
1 South England     25         0.440    84
2 North England     15         0.431    51
3 Scotland           5.5       0.733   300
4 Wales              3         0.651    43
5 Northern Ireland   1.9       0.727    22</code></pre>
</div>
</div>
<p>Here we can see that</p>
<ul>
<li>our sample has a high proportion (300/500) from Scotland</li>
<li>in the sample, this stratum has the highest proportion (73%) in favour of rejoining</li>
<li>in the population, this is one of the smaller strata.</li>
</ul>
<p>Hence the estimate of 65% in favour of rejoining is likely to be an overestimate.</p>
<p>We could estimate the population proportion simply by using <a href="#eq-xbarst" class="quarto-xref">Equation&nbsp;<span>11.2</span></a>:</p>
<p><span class="math display">\[
\bar{x}_{st} = \sum_{i=1}^6 \frac{N_i}{N}\bar{x}_i
\]</span> In R we do</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(combined<span class="sc">$</span>N_i <span class="sc">/</span> <span class="fu">sum</span>(combined<span class="sc">$</span>N_i) <span class="sc">*</span> combined<span class="sc">$</span>prop_rejoin)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.493078</code></pre>
</div>
</div>
<p>which gives a lower estimate of 49%.</p>
<section id="using-a-multi-level-regression-model" class="level4" data-number="11.5.1.1">
<h4 data-number="11.5.1.1" class="anchored" data-anchor-id="using-a-multi-level-regression-model"><span class="header-section-number">11.5.1.1</span> Using a multi-level regression model</h4>
<p>An alternative to using <a href="#eq-xbarst" class="quarto-xref">Equation&nbsp;<span>11.2</span></a> is to model the relationship between the covariates that define the strata (region in this example) and the quantity of interest. This may be preferable when we have multiple covariates of interest; we will discuss this shortly.</p>
<p>We write that participant <span class="math inline">\(i\)</span> is in region <span class="math inline">\(j_i\in\{1,2,3,4,5\}\)</span>. We observe a binary outcome <span class="math inline">\(\text{rejoin}_i\in\{0,1\}\)</span> for each participant. We use a <strong>logistic</strong> regression model with <strong>random effects</strong> for region.</p>
<p><span class="math display">\[
\text{rejoin}_i \sim \text{Bernoulli}(\pi_i),
\]</span> with <span id="eq-logreg"><span class="math display">\[\log \left(\frac{\pi_i}{1-\pi_i}\right) = \beta_0 + \gamma_{j_i}
\tag{11.5}\]</span></span></p>
<p>If you haven’t seen a logistic regression model before, the idea behind <a href="#eq-logreg" class="quarto-xref">Equation&nbsp;<span>11.5</span></a> is that if we tried to specify a model such as <span class="math inline">\(E(\text{rejoin}_i) = \pi_i=\beta_0 + \gamma_{j_i}\)</span>, we have the problem that <span class="math inline">\(\pi_i\)</span> is bounded between 0 and 1, which then makes estimation of all the parameters on the right hand side awkward. The “logistic” transformation <span class="math inline">\(\log(\pi_i/(1-\pi_i))\)</span> in <a href="#eq-logreg" class="quarto-xref">Equation&nbsp;<span>11.5</span></a> gives a quantity on the left hand side that is unbounded.</p>
<p>The parameters <span class="math inline">\(\gamma_1,\ldots,\gamma_5\)</span> describing the effects of region are modelled as <em>random variables</em>, not constants:</p>
<p><span id="eq-randomeffects"><span class="math display">\[
\gamma_j \sim N(0, \sigma^2), \quad \text{for } j = 1, \ldots,5.
\tag{11.6}\]</span></span></p>
<p>This idea of modelling parameters as random variables goes by various different names, which all broadly mean the same thing:</p>
<ul>
<li>a multi-level model</li>
<li>a random effects model</li>
<li>a (Bayesian) hierarchical model</li>
</ul>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>Random effects/multi-level/hierarchical models
</div>
</div>
<div class="callout-body-container callout-body">
<p>We are not going to study these models in much detail; they are covered more in other modules. In brief:</p>
<ul>
<li>the name “random effects” comes from treating the effect parameters (region effects in this example) as random variables.</li>
<li>the names “multi-level” and “hierarchical” both refer to the model structure. At the top level, the response variable (<span class="math inline">\(\text{rejoin}_i\)</span>) is expressed as a random variable, dependent on a particular parameter (<span class="math inline">\(\pi_i\)</span>). At the next level down, this parameter is <em>also</em> expressed as a random variable: a function of random variable <span class="math inline">\(\gamma_{j_i}\)</span> in this case.</li>
<li>the assumption that <span class="math inline">\(\gamma_1,\ldots,\gamma_5\)</span> are normally distributed with mean 0 pulls estimates of these parameters towards 0: this is referred to as “shrinkage”</li>
<li>these models can enable “borrowing strength” between strata: as we get data from some strata and learn about <span class="math inline">\(\beta_0\)</span> and <span class="math inline">\(\sigma^2\)</span>, this gives information about what to expect in other strata. This can be helpful if a particular strata has a small sample size.</li>
</ul>
</div>
</div>
<p>We can fit the model described above using the <code>lme4</code> package</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>mrp <span class="ot">&lt;-</span> <span class="fu">glmer</span>(rejoin <span class="sc">~</span> (<span class="dv">1</span> <span class="sc">|</span> region), </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">data =</span> survey, </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>The syntax <code>(1 | region)</code> specifies random effects as written in <a href="#eq-randomeffects" class="quarto-xref">Equation&nbsp;<span>11.6</span></a>. Using the model fit, we now obtain the estimated proportion for each strata:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>combined<span class="sc">$</span>estimate <span class="ot">&lt;-</span> <span class="fu">predict</span>(mrp,</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>                             <span class="at">newdata =</span> combined,</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>                             <span class="at">type =</span> <span class="st">"response"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>If we inspect these estimates, they are all ‘shrunk’ slightly away from the observed proportion in that strata, towards a central value:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>combined</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 5
  region             N_i prop_rejoin   n_i estimate
  &lt;chr&gt;            &lt;dbl&gt;       &lt;dbl&gt; &lt;int&gt;    &lt;dbl&gt;
1 South England     25         0.440    84    0.464
2 North England     15         0.431    51    0.469
3 Wales              3         0.651    43    0.637
4 Scotland           5.5       0.733   300    0.726
5 Northern Ireland   1.9       0.727    22    0.674</code></pre>
</div>
</div>
<p>To get the overall estimate from the MRP model, we weight the estimates in each strata by the strata size:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(combined<span class="sc">$</span>N_i <span class="sc">/</span> <span class="fu">sum</span>(combined<span class="sc">$</span>N_i) <span class="sc">*</span> combined<span class="sc">$</span>estimate)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.5126898</code></pre>
</div>
</div>
<p>This is slightly above the estimate from <a href="#eq-xbarst" class="quarto-xref">Equation&nbsp;<span>11.2</span></a>, but still lower than the raw proportion from the survey</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>Why bother with all this?
</div>
</div>
<div class="callout-body-container callout-body">
<p>In the example, we had a single covariate: region, resulting in five strata only. But surveys often record multiple covariates, e.g.&nbsp;age group and employment status in addition to region. Each combination of covariate values would define a single strata: e.g.&nbsp;one strata might be all 30-40 year-olds who are currently employed and live in Wales. With many possible combinations there will be a large number of strata, but the multilevel logistic regression model can easily be extended to estimate the effects of multiple covariates, and can better handle problems with small sample sizes within strata through the effect of “borrowing strength” between strata.</p>
</div>
</div>
</section>
</section>
</section>
<section id="tasks" class="level2" data-number="11.6">
<h2 data-number="11.6" class="anchored" data-anchor-id="tasks"><span class="header-section-number">11.6</span> Tasks</h2>
<ol type="1">
<li><p>Derive the variance of <span class="math inline">\(\bar{x}_{st}\)</span></p></li>
<li><p>An organisation wants to estimate the mean CO<span class="math inline">\(_2\)</span> transport emissions of its staff. The organisation has 2000 employees. Three transport mode strata have been identified: car, public transport and walk/cycle. The strata sizes are 200 (car), 500 (public transport) and 1300 (walk/cycle). A stratified SRS of 100 is to be taken. Using proportional allocation, the sample sizes are 10, 25 and 65 respectively. The results of the sample are as follows:</p></li>
</ol>
<table class="caption-top table">
<tbody>
<tr class="odd">
<td></td>
<td style="text-align: center;">Sample mean (tonnes)</td>
<td style="text-align: left;">Sample variance (tonnes<span class="math inline">\(^2\)</span>)</td>
</tr>
<tr class="even">
<td>car</td>
<td style="text-align: center;">0.82</td>
<td style="text-align: left;">0.35</td>
</tr>
<tr class="odd">
<td>public transport</td>
<td style="text-align: center;">0.28</td>
<td style="text-align: left;">0.26</td>
</tr>
<tr class="even">
<td>walk/cycle</td>
<td style="text-align: center;">0.13</td>
<td style="text-align: left;">0.02</td>
</tr>
</tbody>
</table>
<p>Calculate a 95% CI for the mean CO<span class="math inline">\(_2\)</span> transport emissions of its staff based on these results. You can ignore the finite population correction.</p>
<div class="callout callout-style-default callout-caution no-icon callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Caution</span>Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ol type="1">
<li><p>We have <span class="math display">\[
Var( \bar{x}_{st}) =Var\left(\frac{1}{N}\sum_1^l N_i\bar{x}_i\right)= \frac{1}{N^2}\sum_1^lVar(N_i\bar{x}_i) = \sum_1^l\left(\frac{N_i}{N}\right)^2\frac{1 - f_i}{n_i}S_i^2,
\]</span> as <span class="math inline">\(\bar{x_i}\)</span> is the sample mean obtained from an SRS of size <span class="math inline">\(n_i\)</span> drawn from a population of size <span class="math inline">\(N_i\)</span> with population variance <span class="math inline">\(S_i^2\)</span>.</p></li>
<li><p>We have <span class="math display">\[\overline{x}_{st}=0.1(0.82)+0.25(0.28)+0.65(0.13)=0.24 ~\text{tonnes of CO}_2.\]</span> Using proportional allocation we have <span class="math inline">\(f_i=n/N=100/2000=0.05\)</span> which is small enough to ignore. This gives the estimator variance as: <span class="math display">\[\text{var}(\overline{x}_{st}) = (0.1)^2\frac{0.35}{10}+(0.25)^2\frac{0.26}{25}+(0.65)^2\frac{0.02}{65}=0.0011\]</span> The 95% CI is then <span class="math display">\[\overline{x}_{st} \pm 1.96 \sqrt{\text{var}(\overline{x}_{st})}=0.24 \pm 2\sqrt{0.0011}=(0.17, 0.31)\]</span></p></li>
</ol>
</div>
</div>
</div>
</section>
<section id="appendix-proofs" class="level2" data-number="11.7">
<h2 data-number="11.7" class="anchored" data-anchor-id="appendix-proofs"><span class="header-section-number">11.7</span> Appendix: proofs</h2>
<section id="proof-that-barx_st-is-the-best-linear-unbiased-estimator" class="level3" data-number="11.7.1">
<h3 data-number="11.7.1" class="anchored" data-anchor-id="proof-that-barx_st-is-the-best-linear-unbiased-estimator"><span class="header-section-number">11.7.1</span> Proof that <span class="math inline">\(\bar{x}_{st}\)</span> is the best linear unbiased estimator</h3>
<p>Consider a general linear estimator of <span class="math inline">\(\overline{X}\)</span> <span class="math display">\[ t = \sum_{i,j} c_{ij}x_{ij} \]</span> where the <span class="math inline">\(c_{ij}\)</span> are constants.</p>
<p>Unbiasedness implies <span class="math display">\[\begin{align}
E(t) &amp; =  \sum_{ij} c_{ij} \overline{X}_i \\
&amp; =  \sum_{i=1}^l \left(\sum_{j=1}^{n_i} c_{ij}\right)
\overline{X}_{i} \\ &amp; =  \overline{X} = \sum_{i=1}^l
\left(\frac{N_i}{N}\right)
\overline{X}_i\mbox{ whatever}\overline{X}_i \\
\mbox{and so }\sum_{j=1}^{n_i} c_{ij} &amp; =  \frac{N_i}{N}
\mbox{ for each }i.
\end{align}\]</span> Since the SRS’s from different strata are independent,</p>
<p><span class="math display">\[ Var(t) =\sum_{i=1}^lVar\left(\sum_{j=1}^{n_i}
c_{ij}x_{ij}\right)\]</span> and we minimise this by minimising it for each <span class="math inline">\(i\)</span> separately. But within each stratum this is essentially the same problem as for SRS , and the solution is that the <span class="math inline">\(c_{ij}\)</span> should be equal to each other, which means, bearing in mind the above constraint, that <span class="math display">\[c_{ij} = \frac{N_i}{Nn_i}\mbox{ for }j=1,\ldots ,n_i\]</span> and so in SSRS the BLUE of <span class="math inline">\(\overline X\)</span> is <span class="math display">\[\overline{x}_{st} = \sum_{i=1}^l \frac{N_i}{N} \overline{x}_i. \]</span></p>
</section>
<section id="stratification-vs-srs" class="level3" data-number="11.7.2">
<h3 data-number="11.7.2" class="anchored" data-anchor-id="stratification-vs-srs"><span class="header-section-number">11.7.2</span> Stratification vs SRS</h3>
<p>We have <span class="math display">\[ Var(\overline{x}_{st(p)}) = \sum_1^l \left( \frac{N_i}{N}
\right)^2 \left(1-\frac{n}{N}\right)\frac{S_i^2}{n_i} =
\frac{1-f}{nN} \sum_1^l N_iS_i^2 \]</span> whereas <span class="math display">\[Var(\overline{x})= \frac{1-f}{n}S^2 = \frac{1-f}{n(N-1)} \left\{
\sum_{i=1}^l (N_i-1)S_i^2 + \sum_{i=1}^l N_i(\overline{X}_i -
\overline{X})^2 \right\} . \]</span><br>
Thus <span class="math display">\[Var(\overline{x})-Var(\overline{x}_{st(p)})=\frac{1-f}{n(N-1)}
\left\{-\sum_{i=1}^l\frac{N-N_i}{N}S_i^2 +
\sum_{i=1}^lN_i(\overline{X}_i - \overline{X})^2 \right\}
\]</span> which is non-negative iff <span class="math display">\[\sum N_i(\overline{X}_i - \overline{X})^2 \geq \sum
\left(1-\frac{N_i}{N}\right) S_i^2. \]</span></p>
</section>
</section>
<section id="appendix-sample-size-choices" class="level2" data-number="11.8">
<h2 data-number="11.8" class="anchored" data-anchor-id="appendix-sample-size-choices"><span class="header-section-number">11.8</span> Appendix: sample size choices</h2>
<p>Here, we give some methods for choosing sample sizes when stratum population variances are known.</p>
<p>Suppose that the cost of the survey consists of a basic overhead cost, <span class="math inline">\(c_0\)</span> say, and a cost associated with each unit measured. This unit measurement cost could differ between strata. We denote its value in stratum <span class="math inline">\(i\)</span> by <span class="math inline">\(c_i\)</span>. Then the overall cost, <span class="math inline">\(C\)</span> say, of the survey is of the form <span class="math display">\[C = c_0+\sum_{i=1}^l c_in_i.\]</span></p>
<p>Suppose we wish to choose the <span class="math inline">\(n_i\)</span> to minimise var&nbsp;<span class="math inline">\(\overline{x}_{st}\)</span> for a specified total cost <span class="math inline">\(C\)</span>. (We might equally wish to minimise cost for a specified variance: the argument in that case is similar.)</p>
<section id="minimising-variance-within-a-fixed-cost." class="level3" data-number="11.8.1">
<h3 data-number="11.8.1" class="anchored" data-anchor-id="minimising-variance-within-a-fixed-cost."><span class="header-section-number">11.8.1</span> Minimising Variance Within a Fixed Cost.</h3>
<p>We want to choose the <span class="math inline">\(n_i\)</span> to minimize <span class="math display">\[\begin{align}
\mbox{var}(\overline{x}_{st}) &amp; =  \sum_1^l\left(\frac{N_i}{N}\right)^2\left(1-\frac{n_i}{N_i}\right)\frac{S_i^2}{n_i}\\
&amp; = \sum_1^l \left(\frac{N_i}{N}\right)^2\frac{S_i^2}{n_i}-\sum_1^l \left(\frac{N_i}{N}\right)^2\frac{S_i^2}{N_i}
\end{align}\]</span> subject to <span class="math display">\[c_0+\sum_1^l c_in_i = C.\]</span> Using Lagrange multipliers, we find that the optimal size of sample from the <span class="math inline">\(i\)</span>th stratum is <span class="math display">\[n_i \propto \frac{N_iS_i}{\sqrt{c_i}}\mbox{~~~~for~}i=1,\dots,l.\]</span> As one might expect, we should take a larger sample in a given stratum if</p>
<ol type="1">
<li><p>the stratum is larger,</p></li>
<li><p>the stratum is more variable internally,</p></li>
<li><p>sampling is cheaper in the stratum.</p></li>
</ol>
<p>Putting the formula for <span class="math inline">\(n_i\)</span> in the cost constraint, we can deduce the constant of proportionality, and the optimal total number of observations for cost <span class="math inline">\(C\)</span>: <span class="math display">\[\begin{align}
n_i &amp;=\frac{(C-c_0)\frac{N_iS_i}{\sqrt{c_i}}}{\sum_1^lN_iS_i\sqrt{c_i}},\\
n &amp;= \frac{(C-c_0)\sum_1^l \frac{N_iS_i}{\sqrt{c_i}}}{\sum_1^lN_iS_i\sqrt{c_i}}.
\end{align}\]</span> (In practice we would round <span class="math inline">\(n\)</span> and <span class="math inline">\(n_i\)</span> to the nearest integers.) To use this result, we need to know the sizes <span class="math inline">\(N_i\)</span> of the strata and the stratum variances <span class="math inline">\(S_i^2\)</span>. The latter are usually unknown and would have to be estimated from a pilot survey or from knowledge of another similar survey.</p>
</section>
<section id="special-case-c_i-constant." class="level3" data-number="11.8.2">
<h3 data-number="11.8.2" class="anchored" data-anchor-id="special-case-c_i-constant."><span class="header-section-number">11.8.2</span> Special Case: <span class="math inline">\(c_i\)</span> constant.</h3>
<p>In the case when measurement of a unit costs the same whichever stratum it comes from, so that the overall cost is <span class="math inline">\(C=c_0+cn\)</span>, then <span class="math display">\[\begin{align}
n &amp; =  \frac{C-c_0}{c} \\
\mbox{and}\; n_i &amp; =  \frac{nN_iS_i}{\sum_1^l N_iS_i}\; \mbox{for} i=1,\dots,l.
\end{align}\]</span> This is called the <strong>Neyman allocation</strong>. For the Neyman allocation, we have <span class="math display">\[\mbox{var~}\overline{x}_{st} =  \frac{1}{N^2} \frac{ (\sum N_iS_i)^2}{n} - \frac{ \sum N_iS_i^2 }{N^2}.\]</span></p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./Sample sizes and confidence intervals.html" class="pagination-link" aria-label="Confidence intervals and sample sizes">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Confidence intervals and sample sizes</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./Population size.html" class="pagination-link" aria-label="Estimating a Population Size">
        <span class="nav-page-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Estimating a Population Size</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>