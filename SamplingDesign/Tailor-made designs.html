<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>14&nbsp; Modifying designs – MPS318/4101 Sampling Theory and Design of Experiments</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./Cluster sampling.html" rel="next">
<link href="./Practicalities.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-27c261d06b905028a18691de25d09dde.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./Tailor-made designs.html">Part III: MPS4101 only</a></li><li class="breadcrumb-item"><a href="./Tailor-made designs.html"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Modifying designs</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="./index.html" class="sidebar-logo-link">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="./">MPS318/4101 Sampling Theory and Design of Experiments</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Instructions</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Part I: Experimental Design</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Introduction to experimental design.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction to Experimental Design</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Review of linear models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">A review of linear models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Optimality.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Optimality criteria</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Qualitative-single factor.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Qualitative explanatory variables and blocking</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Qualitative-multiple factors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Latin Square designs</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Factorial designs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Factorial designs</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Continuous and exact designs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Continuous and exact designs</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Part II: Sampling Theory</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Introduction to sampling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Introduction to Sampling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Simple random sampling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Simple Random Sampling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Sample sizes and confidence intervals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Confidence intervals and sample sizes</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Stratified sampling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Stratified Sampling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Population size.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Estimating a Population Size</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Practicalities.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Reliability of sample surveys</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Part III: MPS4101 only</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Tailor-made designs.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Modifying designs</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Cluster sampling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Cluster Sampling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Introduction-computer-experiments.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Introduction to computer experiments</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Uncertainty-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Uncertainty analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Sensitivity-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Sensitivity analysis</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#adding-a-point" id="toc-adding-a-point" class="nav-link active" data-scroll-target="#adding-a-point"><span class="header-section-number">14.1</span> Adding a point</a></li>
  <li><a href="#deleting-a-point" id="toc-deleting-a-point" class="nav-link" data-scroll-target="#deleting-a-point"><span class="header-section-number">14.2</span> Deleting a point</a></li>
  <li><a href="#adding-two-points" id="toc-adding-two-points" class="nav-link" data-scroll-target="#adding-two-points"><span class="header-section-number">14.3</span> Adding two points</a></li>
  <li><a href="#changing-a-point" id="toc-changing-a-point" class="nav-link" data-scroll-target="#changing-a-point"><span class="header-section-number">14.4</span> Changing a point</a></li>
  <li><a href="#tasks" id="toc-tasks" class="nav-link" data-scroll-target="#tasks"><span class="header-section-number">14.5</span> Tasks</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./Tailor-made designs.html">Part III: MPS4101 only</a></li><li class="breadcrumb-item"><a href="./Tailor-made designs.html"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Modifying designs</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span id="sec-modifying" class="quarto-section-identifier"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Modifying designs</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>This Chapter follows on from <a href="Continuous and exact designs.html" class="quarto-xref"><span>Chapter 7</span></a>.</p>
<div class="callout callout-style-default callout-caution no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Caution</span>Aims for this chapter
</div>
</div>
<div class="callout-body-container callout-body">
<p>In this chapter we suppose that an initial design has been proposed, but modifications are needed, for example if it is too expensive to obtain all the observations, or additional observations are needed to fit a more complex model than originally intended. Specifically, we consider procedures for</p>
<ol type="1">
<li><p>identifying the best design point to add to an existing design;</p></li>
<li><p>identifying which design point to remove from an existing design, when removing a design point is necessary.</p></li>
</ol>
</div>
</div>
<section id="adding-a-point" class="level2" data-number="14.1">
<h2 data-number="14.1" class="anchored" data-anchor-id="adding-a-point"><span class="header-section-number">14.1</span> Adding a point</h2>
<p>Here, using <span class="math inline">\(D\)</span>-optimality as a guiding principle, we look at the problem of either adding a new point to an existing design to accommodate an extra observation, or deleting a point from an existing design. The following result from matrix theory is of independent interest elsewhere, and particularly useful here.</p>
<div class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Warning</span>Lemma
</div>
</div>
<div class="callout-body-container callout-body">
<div id="lem-addpoint" class="theorem lemma">
<p><span class="theorem-title"><strong>Lemma 14.1</strong></span> If <span class="math inline">\(\mathbf{A}\)</span> is a non-singular <span class="math inline">\(p\times p\)</span> matrix, <span class="math inline">\(\mathbf{B}\)</span> is a <span class="math inline">\(p\times n\)</span> matrix, <span class="math inline">\(\mathbf{C}\)</span> is a <span class="math inline">\(n\times p\)</span> matrix and <span class="math inline">\(\mathbf{I}\)</span> is the <span class="math inline">\(n\times n\)</span> identity matrix, then <span class="math display">\[|\mathbf{A}+\mathbf{B}\mathbf{C}|=|\mathbf{A}||\mathbf{I}+\mathbf{C}\mathbf{A}^{-1}\mathbf{B}|.\]</span></p>
</div>
</div>
</div>
<p>We shall not prove this lemma, but merely explain its application. Suppose we have an existing design with design matrix <span class="math inline">\(\mathbf{x}\)</span> for a particular model, and we wish to add an extra point <span class="math inline">\(\mathbf{x}\)</span> to the design to yield an extra observation. Then, bearing in mind the definition of the information matrix, the information matrix of the new design may be written <span class="math display">\[\mathbf{G}^*=\mathbf{X}^T\mathbf{X}+\mathbf{f}(\mathbf{x})\mathbf{f}(\mathbf{x})^T=\mathbf{G}+\mathbf{f}(\mathbf{x})\mathbf{f}(\mathbf{x})^T\]</span> where <span class="math inline">\(\mathbf{G}\)</span> is the information matrix of the original design. If this result isn’t obvious to you then check it in the simple linear regression case with <span class="math inline">\(n\)</span> observation in the original design matrix. If we now apply the lemma to determinants, with <span class="math inline">\(n=1\)</span>, <span class="math inline">\(\mathbf{A}=\mathbf{G}\)</span>, <span class="math inline">\(\mathbf{B}=\mathbf{f}(\mathbf{x})\)</span> and <span class="math inline">\(\mathbf{C}=\mathbf{f}(\mathbf{x})^T\)</span>, then, noting that the second determinant on the right hand side is just that of a scalar, namely itself, we get <span class="math display">\[|\mathbf{G}^*|=|\mathbf{G}|\left(1+\mathbf{f}(\mathbf{x})^T\mathbf{G}^{-1}\mathbf{f}(\mathbf{x}) \right).\]</span> It follows from the simple multiplicative factor on the right hand side that it is <span class="math inline">\(D\)</span>-optimal to choose the point <span class="math inline">\(\mathbf{x}\)</span> for which this is as large as possible. But <span class="math inline">\(\mathbf{f}(\mathbf{x})^T\mathbf{G}^{-1}\mathbf{f}(\mathbf{x})\)</span> is just, apart from a multiplicative factor, the variance of prediction at the point <span class="math inline">\(\mathbf{x}\)</span>. It follows that <em>if a new point is to be added to the design, it is</em> <span class="math inline">\(D\)</span>-optimal to choose one with the largest variance of prediction (for the existing design). This is intuitive: such a point is in a part of the design region where we know least about the fit of the model.</p>
</section>
<section id="deleting-a-point" class="level2" data-number="14.2">
<h2 data-number="14.2" class="anchored" data-anchor-id="deleting-a-point"><span class="header-section-number">14.2</span> Deleting a point</h2>
<p>We can work out a similar result for deleting an existing point <span class="math inline">\(\mathbf{x}\)</span> from a design. The plus signs may be replaced by minus signs in the lemma, and in the modification of the information matrix, and so we can say that the new information matrix has determinant <span class="math display">\[|\mathbf{G}^*|=|\mathbf{G}|\left(1-\mathbf{f}(\mathbf{x})^T\mathbf{G}^{-1} \mathbf{f}(\mathbf{x})\right)\]</span> and so it is <span class="math inline">\(D\)</span>-optimal to delete a point of the existing design at which the variance of prediction is <em>least</em>.</p>
</section>
<section id="adding-two-points" class="level2" data-number="14.3">
<h2 data-number="14.3" class="anchored" data-anchor-id="adding-two-points"><span class="header-section-number">14.3</span> Adding two points</h2>
<p>If we wish to modify a design by changing more than one point, the situation is not so clear: doing it optimally stepwise one point at a time is not obviously going to produce a design which is optimal among all choices of more than one design point, although often it will.</p>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Example
</div>
</div>
<div class="callout-body-container callout-body">
<div id="exm-add2" class="theorem example">
<p><span class="theorem-title"><strong>Example 14.1</strong></span> Quadratic regression on one explanatory variable. Suppose we have taken one observation at <span class="math inline">\(x=-1\)</span>, one observation at <span class="math inline">\(x=0\)</span> and two observations at <span class="math inline">\(x=1\)</span>. Then we have <span class="math display">\[\mathbf{x}= \left( \begin{array}{ccc} 1 &amp; -1 &amp; 1 \\ 1 &amp; 0 &amp; 0 \\ 1 &amp; 1&amp; 1 \\ 1 &amp; 1 &amp; 1 \end{array} \right) ~~\text{and}~~ \mathbf{G}= \left(\begin{array}{ccc} 4 &amp; 1 &amp; 3 \\ 1 &amp; 3 &amp; 1 \\ 3 &amp; 1 &amp; 3 \end{array}\right).\]</span> Then <span class="math display">\[\mathbf{G}^{-1}=\frac{1}{8}\left(\begin{array}{ccc}8&amp;0&amp;-8\\0&amp;3&amp;-1\\-8&amp;-1&amp;11\end{array}\right)\]</span> and <span class="math display">\[\begin{align}
\mathbf{f}(\mathbf{x})^T\mathbf{G}^{-1}\mathbf{f}(\mathbf{x})&amp;=\frac{1}{8} \left(\begin{array}{ccc} 1 &amp; x &amp; x^2 \end{array} \right) \left(
\begin{array}  {ccc} 8 &amp; 0 &amp; -8 \\ 0 &amp; 3 &amp; -1 \\ -8 &amp; -1 &amp; 11
\end{array} \right) \left( \begin{array}{c} 1 \\ x \\ x^2
\end{array} \right) \\
&amp;=\frac{1}{8}\left( 8 - 13x^2 - 2x^3 + 11 x^4 \right)
\end{align}\]</span> This quartic (fourth order polynomial) has a local maximum value of 1 at <span class="math inline">\(x=0\)</span>, as may be checked by calculus. It also takes the value 1 at <span class="math inline">\(x=-1\)</span>, the left-hand endpoint of the interval, and it takes a smaller value at the other endpoint, <span class="math inline">\(x=1\)</span>. We conclude from this that, if an extra point is to be added to the design, <span class="math inline">\(x=0\)</span> and <span class="math inline">\(x=-1\)</span> are equally <span class="math inline">\(D\)</span>-optimal. To check this sketch the curve. So according to the <span class="math inline">\(D\)</span> optimality criterion, we can add either one of these two points . The following task asks you to work out the next <span class="math inline">\(D\)</span>-optimal point to add, assuming we have added <span class="math inline">\(x=-1\)</span>.</p>
</div>
</div>
</div>
<p>If the intention is merely to investigate the effect of a two-stage modification of the design, the following lemma comes in useful. Again, we state the lemma without proof.</p>
<div class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Warning</span>Lemma
</div>
</div>
<div class="callout-body-container callout-body">
<div id="lem-lem2" class="theorem lemma">
<p><span class="theorem-title"><strong>Lemma 14.2</strong></span> Under the same conditions as in <a href="#lem-addpoint" class="quarto-xref">Lemma&nbsp;<span>14.1</span></a>, <span class="math display">\[(\mathbf{A}+\mathbf{B}\mathbf{C})^{-1}=\mathbf{A}^{-1}-\mathbf{A}^{-1}\mathbf{B}(\mathbf{I}+\mathbf{C}\mathbf{A}^{-1}\mathbf{B})^{-1} \mathbf{C}\mathbf{A}^{-1}\]</span> provided the inverses on both sides exist.</p>
</div>
</div>
</div>
<p>The application of this is when, say, we first add a new point <span class="math inline">\(\mathbf{x}\)</span> to the design, changing the information matrix from <span class="math inline">\(\mathbf{G}\)</span> to <span class="math inline">\(\mathbf{G}_1\)</span>, say, and then add another new point <span class="math inline">\(\mathbf{y}\)</span>, changing it to <span class="math inline">\(\mathbf{G}_2\)</span>, say. We then have <span class="math display">\[\begin{align}
|\mathbf{G}_2|&amp;=|\mathbf{G}_1|\left(1+\mathbf{f}(\mathbf{y})^T\mathbf{G}_1^{-1}\mathbf{f}(\mathbf{y})\right) \\
&amp;=|\mathbf{G}_1|\left(1+\mathbf{f}(\mathbf{y})^T(\mathbf{G}+\mathbf{f}(\mathbf{x})\mathbf{f}(\mathbf{x})^T)^{-1}\mathbf{f}(\mathbf{y}) \right) \\
&amp;=|\mathbf{G}_1|\left( 1 + \mathbf{f}(\mathbf{y})^T\mathbf{G}^{-1}\mathbf{f}(\mathbf{y})-\mathbf{f}(\mathbf{y})^T\mathbf{G}^{-1}\mathbf{f}(\mathbf{x})(1 + \mathbf{f}(\mathbf{x})^T\mathbf{G}^{-1}\mathbf{f}(\mathbf{x}))^{-1}\mathbf{f}(\mathbf{x})^T\mathbf{G}^{-1}\mathbf{f}(\mathbf{y})\right)
\end{align}\]</span> using <a href="#lem-lem2" class="quarto-xref">Lemma&nbsp;<span>14.2</span></a> with the same interpretations of the matrices as in the application of <a href="#lem-addpoint" class="quarto-xref">Lemma&nbsp;<span>14.1</span></a>. This expression now simplifies because the right hand side consists of scalar quantities, and also because we may substitute <span class="math inline">\(|\mathbf{G}_1| = |\mathbf{G}|(1 + \mathbf{f}(\mathbf{x})^T\mathbf{G}^{-1}\mathbf{f}(\mathbf{x}))\)</span>. This gives <span class="math display">\[|\mathbf{G}_2| = |\mathbf{G}|\left\{ \left( 1 + \mathbf{f}(\mathbf{x})^T\mathbf{G}^{-1}\mathbf{f}(\mathbf{x}
) \right) \left( 1 + \mathbf{f}(\mathbf{y})^T\mathbf{G}^{-1}\mathbf{f}(\mathbf{y}) \right) -
\left( \mathbf{f}(\mathbf{x})^T\mathbf{G}^{-1}\mathbf{f}(\mathbf{y}) \right) ^2 \right\}.\]</span> Using this we can assess the effect on the information matrix of adding two new points <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span>.</p>
</section>
<section id="changing-a-point" class="level2" data-number="14.4">
<h2 data-number="14.4" class="anchored" data-anchor-id="changing-a-point"><span class="header-section-number">14.4</span> Changing a point</h2>
<p>Similarly if we delete an existing point <span class="math inline">\(\mathbf{x}\)</span> from a design and then add a new point <span class="math inline">\(\mathbf{y}\)</span> we get <span class="math display">\[|\mathbf{G}_2| = |\mathbf{G}|\left\{ \left( 1 - \mathbf{f}(\mathbf{x})^T\mathbf{G}^{-1}\mathbf{f}(\mathbf{x})  \right) \left( 1 + \mathbf{f}(\mathbf{y})^T\mathbf{G}^{-1}\mathbf{f}(\mathbf{y}) \right) + \left( \mathbf{f}(\mathbf{x})^T\mathbf{G}^{-1}\mathbf{f}(\mathbf{y}) \right) ^2 \right\} .\]</span></p>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Example
</div>
</div>
<div class="callout-body-container callout-body">
<div id="exm-changept" class="theorem example">
<p><span class="theorem-title"><strong>Example 14.2</strong></span> Simple linear regression with four observations at <span class="math inline">\(x=-1, -1, 0\)</span> and <span class="math inline">\(1\)</span>. In this case, <span class="math display">\[\mathbf{G}= \left( \begin{array}{cc} 4 &amp; -1 \\ -1 &amp; 3 \end{array}
\right)~~\text{and}~~\mathbf{G}^{-1} = \frac{1}{11}\left(\begin{array}{cc} 3 &amp; 1 \\ 1&amp; 4 \end{array} \right).\]</span> Suppose we replace one of the observations at <span class="math inline">\(x=-1\)</span> with one at <span class="math inline">\(x=1\)</span>. Then the relevant quantities are <span class="math display">\[\begin{align}
\mathbf{f}(-1)^T\mathbf{G}^{-1}\mathbf{f}(-1) &amp;= \frac{1}{11} \left(
\begin{array}{cc} 1 &amp; -1 \end{array} \right) \left(
\begin{array}{cc} 3 &amp; 1 \\ 1 &amp; 4 \end{array} \right) \left(
\begin{array}{c} 1 \\ -1 \end{array} \right) = \frac{5}{11} \\
\mathbf{f}(1)^T\mathbf{G}^{-1}\mathbf{f}(1) &amp;= \frac{1}{11} \left(
\begin{array}{cc} 1 &amp; 1 \end{array} \right) \left(
\begin{array}{cc} 3 &amp; 1 \\ 1 &amp; 4 \end{array} \right) \left(
\begin{array}{c} 1 \\ 1 \end{array} \right) = \frac{9}{11} \\
\text{and}~~\mathbf{f}(-1)^T\mathbf{G}^{-1}\mathbf{f}(1) &amp;= \frac{1}{11} \left(
\begin{array}{cc} 1 &amp; -1 \end{array} \right) \left(
\begin{array}{cc}  3 &amp; 1 \\ 1 &amp; 4 \end{array} \right) \left(
\begin{array}{c} 1 \\ 1 \end{array} \right) = -\frac{1}{11}
\end{align}\]</span> and so, substituting, <span class="math display">\[|\mathbf{G}_2|=|\mathbf{G}|\left\{\left(1-\frac{5}{11}\right)\left(1+\frac{9}{11}\right)+\left(-\frac{1}{11}\right)^2\right\}=|\mathbf{G}|.\]</span> In this case, the result is not surprising, since the design is merely being reflected about the origin, and so we would expect its essential properties not to change.</p>
</div>
</div>
</div>
</section>
<section id="tasks" class="level2" data-number="14.5">
<h2 data-number="14.5" class="anchored" data-anchor-id="tasks"><span class="header-section-number">14.5</span> Tasks</h2>
<ol type="1">
<li><p>Assume that <span class="math inline">\(x=-1\)</span> is added to the design in <a href="#exm-add2" class="quarto-xref">Example&nbsp;<span>14.1</span></a>. Is it true that it is now <span class="math inline">\(D\)</span>-optimal to add the point <span class="math inline">\(x=0\)</span> and hence restore the symmetry of the design?</p></li>
<li><p>Find an optimal design with two observations for the model <span class="math display">\[\begin{equation} E(Y)=\beta_1x_1+\beta_2x_2 \end{equation}\]</span> using the points <span class="math inline">\((-1,-1), (1,-1), (-1,1)\)</span> and <span class="math inline">\((1,1)\)</span> as candidate points. Does it satisfy the conditions of the General Equivalence Theorem? If a third observation were to be added to the design, where would you choose to take it?</p></li>
<li><p>In the simple linear regression model <span class="math display">\[\begin{equation} E(Y)=\beta_0+\beta_1x \end{equation}\]</span> a design has three observations taken at <span class="math inline">\(x=-1,0\)</span> and <span class="math inline">\(1\)</span>. Investigate the effect of replacing the observation at <span class="math inline">\(x=0\)</span> by an observation at <span class="math inline">\(x=a\neq 0\)</span>. Which value(s) of <span class="math inline">\(a\)</span> give(s) the best results?</p></li>
</ol>
<div class="callout callout-style-default callout-caution no-icon callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-6-contents" aria-controls="callout-6" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Caution</span>Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-6" class="callout-6-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ol type="1">
<li><p>If <span class="math inline">\(x=-1\)</span> is added, the design matrix is now <span class="math display">\[X=
\left(
\begin{array}{rrr}
1 &amp;-1 &amp; 1\\
1 &amp;-1 &amp; 1\\
1 &amp; 0 &amp; 0\\
1 &amp; 1 &amp; 1\\
1 &amp; 1 &amp; 1\\
\end{array}
\right)
\]</span> so <span class="math display">\[G=(X^TX)=
\left(
\begin{array}{rrr}
5 &amp; 0 &amp; 4\\
0 &amp; 4 &amp; 0\\
4 &amp; 0 &amp; 4\\
\end{array}
\right)
\]</span> and <span class="math display">\[(X^TX)^{-1}=
\frac{1}{4}
\left(
\begin{array}{rrr}
4 &amp; 0 &amp; -4\\
0 &amp; 1 &amp; 0\\
-4 &amp; 0 &amp; 5\\
\end{array}
\right)
.\]</span> So we have that <span class="math display">\[\begin{align*}
f(x)^TG^{-1}f(x)&amp;=\frac{1}{4}\left(\begin{array}{ccc} 1&amp;x&amp;x^2 \end{array} \right)\left(
\begin{array}{rrr}
4 &amp; 0 &amp; -4\\
0 &amp; 1 &amp; 0\\
-4 &amp; 0 &amp; 5\\
\end{array}
\right)
\left(\begin{array}{c} 1\\x\\x^2 \end{array} \right)\\
&amp;=\frac{1}{4}\left(4+x^2+5x^4-8x^2\right)\\
&amp;=\frac{1}{4}\left(4-7x^2+5x^4\right)\\
&amp;=\frac{1}{4}\left(4-7\left(x^2\right)+5\left(x^2\right)^2\right)
\end{align*}\]</span> Consider the quadratic function <span class="math inline">\(h(t)=4-7t+5t^2\)</span>. This has a minimum at <span class="math inline">\(t=0.7\)</span> with <span class="math inline">\(h(0.7)=1.55\)</span>. When <span class="math inline">\(t=1\)</span> we have <span class="math inline">\(h(1)=2\)</span> and when <span class="math inline">\(t=0\)</span> we have <span class="math inline">\(h(0)=4\)</span>. So <span class="math inline">\(h(t)\)</span> is maximised over <span class="math inline">\([0,1]\)</span> when <span class="math inline">\(t=0\)</span>. So the <span class="math inline">\(D\)</span>-optimal point to add is <span class="math inline">\(x=0\)</span>.</p></li>
<li><p>Choosing two ‘opposite’ points <span class="math inline">\((-1,-1)\)</span> and <span class="math inline">\((1,1)\)</span>, or <span class="math inline">\((-1,1)\)</span> and <span class="math inline">\((1,-1)\)</span>, is no good, because the design matrices <span class="math display">\[ \left( \begin{array}{cc} -1 &amp; -1 \\ 1 &amp; 1 \end{array} \right)
\mbox{ and }\left( \begin{array}{cc} -1 &amp; 1 \\ 1 &amp; -1
\end{array} \right) \]</span> are square and singular, i.e.&nbsp;not of full rank. This only leaves choosing two ‘adjacent’ points, such as <span class="math inline">\((-1,1)\)</span> and <span class="math inline">\((1,1)\)</span>. Obviously, by symmetry, any such pair is suitable. Then <span class="math display">\[ \mathbf X ^T\mathbf X = \left( \begin{array}{cc} -1 &amp; 1 \\ 1 &amp; 1 \end{array}
\right) \left( \begin{array}{cc} -1 &amp; 1 \\ 1 &amp; 1 \end{array} \right)
= \left( \begin{array}{cc} 2 &amp; 0 \\ 0 &amp; 2 \end{array} \right) \]</span> and so the standardised variance of prediction is <span class="math display">\[ 2\left( \begin{array}{cc} x_1 &amp; x_2 \end{array} \right) \left(
\begin{array}{cc} \frac{1}{2} &amp; 0 \\ 0 &amp;
\frac{1}{2} \end{array} \right) \left( \begin{array}{c} x_1 \\ x_2
\end{array} \right) = x_1^2 + x_2 ^2 \]</span> which is maximised when <span class="math inline">\(x_1^2=x_2^2=1\)</span> and its maximum value is 2, so that the conditions of the GET are met. A third observation could be taken at any of the four candidate points, where the standardised variance of prediction is maximised, although if there is any question of whether the model is appropriate or not, it would seem better to choose one of the two points which have not already been chosen.</p></li>
<li><p>The relevant matrices are <span class="math display">\[ \mathbf{X} = \left( \begin{array}{cc} 1 &amp; -1 \\ 1 &amp; 0 \\ 1 &amp; 1
\end{array} \right),\quad \mathbf{G} = \mathbf{X} ^T\mathbf{X} = \left(
\begin{array}{cc} 3 &amp; 0 \\ 0 &amp; 2 \end{array} \right),\quad \mathbf G
^{-1} = \left( \begin{array}{cc} \frac{1}{3} &amp; 0 \\ 0 &amp; \frac{1}{2}
\end{array} \right) . \]</span> Then <span class="math display">\[\begin{eqnarray*}
\mathbf f (0)^T\mathbf G ^{-1}\mathbf f (0) &amp; = &amp; \left( \begin{array}{cc} 1 &amp; 0
\end{array} \right) \left( \begin{array}{cc} \frac{1}{3} &amp; 0 \\ 0 &amp;
\frac{1}{2} \end{array} \right) \left( \begin{array}{c} 1 \\ 0
\end{array} \right) = \frac{1}{3}; \\
\mathbf f (a)^T\mathbf G ^{-1}\mathbf f (a) &amp; = &amp; \left( \begin{array}{cc} 1 &amp; a
\end{array} \right) \left( \begin{array}{cc} \frac{1}{3} &amp; 0 \\ 0 &amp;
\frac{1}{2} \end{array} \right) \left( \begin{array}{c} 1 \\ a
\end{array} \right) = \frac{1}{3} + \frac{1}{2}a^2; \\
\mathbf f (0)^T\mathbf G ^{-1}\mathbf f (a) &amp; = &amp; \left( \begin{array}{cc} 1 &amp; 0
\end{array} \right) \left( \begin{array}{cc} \frac{1}{3} &amp; 0 \\ 0 &amp;
\frac{1}{2} \end{array} \right) \left( \begin{array}{c} 1 \\ a
\end{array} \right) = \frac{1}{3}.
\end{eqnarray*}\]</span></p></li>
</ol>
<p>So <span class="math display">\[ |\mathbf G _2| = |\mathbf G |\left\{ \left( 1 - \frac{1}{3}\right) \left( 1 +
\frac{1}{3} + \frac{1}{2}a^2 \right) + \left( \frac{1}{3} \right) ^2
\right\} = |\mathbf G |\left\{ 1 + \frac{1}{3} a^2 \right\} . \]</span> So there is always an improvement, and the best choice is <span class="math inline">\(a=\pm 1\)</span>.</p>
</div>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./Practicalities.html" class="pagination-link" aria-label="Reliability of sample surveys">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Reliability of sample surveys</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./Cluster sampling.html" class="pagination-link" aria-label="Cluster Sampling">
        <span class="nav-page-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Cluster Sampling</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>